# 清洁测试的漫长旅程

> 原文:[https://dev . to/Mike freedman 12/the-long-journey-to-clean-tests-lpd](https://dev.to/mikefreedman12/the-long-journey-to-clean-tests-lpd)

不需要太多搜索就能找到宣扬 TDD 好处的博客帖子或 twitter 账户。我认为实践这一原则的一个方面被忽视了，因为它是在遗留系统中使用的。

我相信许多开发人员在一个遗留系统中工作，没有测试，并且努力使这个遗留系统变得更好。

处于那个位置的开发人员和提倡 TDD 的理想主义者之间的对话可能是这样的:

我: *“这些测试很难写，而且需要很长时间来运行。”*

理想主义者: *“听起来你的代码写得很差。你的单元测试不应该依赖于外部的依赖，比如数据库和 web 服务调用。它应该只测试业务规则。”*

我: *“我同意这一点，但是我需要测试的功能不是这样写的。”*

**理想主义者:** *“那应该告诉你一些事情。您需要进行重构，将您的业务规则从这些依赖关系中分离出来。”*

我: *“我们正在这方面取得进展，但并不容易。我们的一些业务逻辑与数据库相结合。我们需要重写所有的查询。为了注入依赖项，我们需要改变我们的 API。通过改变 API，我们需要对客户端代码进行大量的修改。对客户端代码进行了大量修改。”*

理想主义者: *“你应该将功能重写为一个单独的类或方法。这样你就可以测试它。当你确定它在工作时，你可以通过切换到新的类/方法来逐步替换客户端代码。”*

我: *“我们正在尝试，但创建这些新对象需要相当多的开发。例如，我们将持久性逻辑编写为存储库并注入它。你建议我们如何着手测试客户端代码？大多数客户端代码也没有自动化测试。一些客户端代码被其他团队使用，他们已经习惯了它的正常工作。很难证明手动测试当前工作的功能是正确的。我提到过这是大量的客户端代码吗？”*

理想主义者: *“你必须从某个地方开始，否则你将永远是手工测试。您应该为一段客户机代码编写一个自动化测试。一旦通过，稍微修改一下代码，使它看起来像你希望的那样。如果测试失败了，做一个修改使它通过，但是仅仅足够使它通过。保持重构，同时保持测试绿色。这样做足够多次，直到功能解耦"*

我: *“我们正在努力，但是测试很难写，而且运行时间很长。”*

重点是，拥有干净、快速运行的测试的旅程可能从编写缓慢而丑陋的测试开始。测试很慢，因为它们测试的是紧密耦合的代码。缓慢的耦合测试仍然扮演着重要的角色:确保所有当前的功能仍然工作，并提供重构的自由。

TDD 的鼓吹者会同意，重构的自由是关键。当你没有它的时候，持续改进循环就被打破了。问题是，在一个遗留系统中，首先获得反馈循环可能是相当困难的。