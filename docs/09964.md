# 赞扬多种数据库设置和 Rails 6

> 原文：<https://dev.to/joecannatti/in-praise-of-multiple-db-setups-and-rails-6-1605>

[![](img/c7c244ed47bffeff4142acb2b8d5d55e.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--WSHNIXGe--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://zafulabs.files.wordpress.com/2019/02/bandwidth-close-up-computer-1148820-1.jpg%3Fw%3D740)

看起来 [Rails 6](https://medium.com/rubyinside/whats-coming-to-rails-6-0-8ec79eea66da) 将包括对配置你的应用程序与多个数据库对话的一流支持。在这篇文章中，我不打算深入探讨这个特性是如何工作的。我认为一旦发布，将会有大量的博客文章和文档讨论这个问题。我想花点时间解释一下**为什么**你想从一个 web 应用程序访问多个数据库。

## 只读连接和追随者数据库

将 web 应用程序连接到两个数据库的一个常见用例是，一个连接到数据库的主读/写实例，另一个连接到同一数据的只读副本。这在尝试扩展系统时非常有用，因为它允许您将复杂的读取查询从主数据库中移出。

这减少了读取和写入之间的[争用](https://en.wikipedia.org/wiki/Block_contention),从而提高了性能。如果您有一个计算用户信息的后台作业，您可以让该后台作业使用 follower 进行读取查询。

主数据库和它的只读从数据库之间总会有一定程度的延迟，因此系统设计时必须考虑到这一点，以使这种策略可用。例如，如果一条记录已经被添加到数据库中，但是还没有被复制到只读的 follower 中，您必须以这样一种方式构建东西，使得它不会产生问题。新记录必须能够在代码的后续运行中被提取出来。

## ETL、预计算等数据仓库原理

另一组设计来自数据仓库领域，可以通过一个连接到多个数据库的 web 应用程序来实现。

该系列中最常见的一种设计用于提前计算复杂的数据转换，以简化实时所需的计算。

例如，假设我们需要进行复杂的计算来确定登录的用户是否具有特殊的黄金状态。类似于“他们是否在过去 60 天内购买了 5 次产品，写了 3 篇产品评论，并完成了 100%的用户资料”。这并不是您希望在每次页面加载时都要查询的内容。

提前计算这个值是解决这类问题的好方法。如果将这一点与前面建议的连接到数据库的只读从动器结合起来，就可以得到一个很好的解决方案，其中后台进程从只读从动器读取数据，进行复杂的计算，并将其写入专门用于存储预计算值的数据库。这使得您的主读写数据库无论如何都不会因为这种相对昂贵的计算而负担过重。

它同样适用于业务分析和报告用例。

## 【单片-】微服务过渡

考虑将应用程序连接到多个数据库另一个绝佳时机是当您开始将一个大型的整体应用程序分解成较小的组件时。

比方说，你计划将你所有的用户信息从主 monolith 拉到一个用户微服务中。一种方法是首先将数据从主数据库转移到新服务专用的数据库中。这将导致您需要重构所有依赖于数据库连接到用户表的地方。一旦您过渡到该服务，这种方法将不再可行。然后，您可以创建一个 Ruby 类，为该数据提供一个接口。这个类将从新数据库中读取数据。

然后，一旦启动了用户微服务，就可以简单地重构该类，从 JSON API 而不是新数据库中读取数据。然后，让用户微服务成为唯一连接到新用户数据库的东西。

这是一种非常常见、安全且强大的架构演进方式。

## 总结起来

Rails 6 引入了一个特性，可以让本文中讨论的所有设计更容易设置。这是一个思考你的系统如何从这些设计中获益的好时机。

我很想听听你们是如何在系统中使用多种数据库设置的。下面评论！