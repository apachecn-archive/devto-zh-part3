# 对抗自主按钮标签…-一个关于调试的故事

> 原文：<https://dev.to/rugk/fighting-an-autonomous-button-tag-a-story-about-debugging-4d7o>

我有了这个简单的按钮标签，并通过一个 JavaScript 库添加了一些 JS 行为，这个 JavaScript 库也是我写的，已经用于页面上的其他按钮。在某些情况下，按钮旁边会显示一条消息，而按钮会触发一个可能改变它的请求。所以，实际上，我没指望这里有什么新奇的东西……(你可以想象，我错了。)

## 这个问题

一开始，有一个错误:当点击新按钮时，它会切换到一条我没有预料到的消息，这条消息实际上只应该在我打开页面时显示。

用调试器检查并深入代码，我看到我的代码按预期执行，只有*之后*它仍然显示奇怪的行为。

事实上，我注意到它触发代码两次，因此显示不同的信息，但我不知道，为什么它被触发两次。注意，我在页面上有其他按钮，点击它们时效果很好。我仔细检查了 HTML 代码，完全相同……(我还是复制了它进行测试，但没有帮助……)

因此，我添加了更多的断点，并一行一行地检查 JS 代码…有一件事完全让我困惑:初始化代码再次运行。运行两次，并触发我的按钮功能。(这本身就是在 init 代码运行时所期望的，因为我是手动调用它的。但只有在页面加载时才会出现一次。)

然而，我没有在按钮点击处理程序中再次调用 init 代码。此外，它怎么能运行我的初始化代码呢？这段代码应该只在页面加载时运行一次。🤔

仔细看了一遍，我终于明白了:正如你在代码中看到的，我将按钮包装在一个 a 标签中，这个标签在本例中没有使用(只有当我添加链接时才会使用)，所以它必须是这样的:它重定向页面，因为我没有设置`href`链接。

```
<a>
    <button id="button">CLICK ME</button>
</a> 
```

Enter fullscreen mode Exit fullscreen mode

所以我把它移除了，最后…令我惊讶的是…它不起作用了。它仍然有提到的错误…

## *【真实】*一期

所以那件事需要继续，我已经假设了浏览器中的一个错误。毕竟，它不应该运行我的初始化代码。至少，我已经准备创建一个缩小的测试用例，这样我就可以在某个地方报告它了。戏剧性的措施是去除大量的 JS，减少可能干扰的东西。鉴于所有其他按钮的工作，它必须在我的新 JS 的一些小错误，毕竟。

我最终删除了我所有的 JS。这样，我至少可以确认这是 HTML 中的一个错误——如果它现在没有出现的话。

可以肯定的是，我还为按钮手动添加了一个“click”事件监听器，这样我就可以看到是不是 click 事件本身导致了它:

```
document.getElementById("button").addEventListener("click", () => {
    console.error("test");
}); 
```

Enter fullscreen mode Exit fullscreen mode

是的，小点击事件被触发了。但是，更重要的是，在这个非常简单的测试案例中，错误消失了！🎉所以至少我确信错误在我的 JS 代码中，或者说我是这样认为的…(后来这被证明是绝对错误的…)

再想一想，我觉得这一定是某种重新装弹。然而，我没有意识到曾经实施过这种事情。

然后我或多或少地偶然发现了一个类似这样的按钮的示例代码:

```
<button type="button">click</button> 
```

Enter fullscreen mode Exit fullscreen mode

你看到`type`属性了吗？这让我大吃一惊。从这一刻起，我知道我已经解决了…这一次，是真的。😃

一个疯狂简单的 HTML 错误，在几个小时的调试后才被发现。

## 发生了什么？

实际上，按钮所做的是重新加载站点。为什么？嗯……，因为是“表单提交按钮”。查看按钮标签的 [MDN 文档，您会看到，默认情况下，一个按钮没有按钮，但有`type=submit`。](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#attr-type)

> `type`
> 按钮的类型。可能的值有:
> 
> *   `submit`:按钮向服务器提交表单数据。**如果未指定属性**，或者属性被动态更改为空值或无效值，这是默认设置。
>     
>     
> *   `reset`:该按钮将所有控件重置为初始值。
>     
>     
> *   `button`:按钮没有默认行为。它可以有与元素事件相关联的客户端脚本，这些脚本在事件发生时被触发。

(由我突出显示)

HTML5 规范的这个疯狂部分要求我**明确定义一个按钮是一个按钮**，因为否则它默认被认为是一个提交按钮，如果没有数据要提交(表单中没有`input`元素)，它只是重新加载站点。在我的情况下，我甚至有数据要提交，但由于环境的原因，它没有显示给我……(见下面的问题)

### 那么为什么我没有看到它重装呢？

如果我有一个正常的网页，我会立即看到重新加载。然而，在我的例子中，我正在开发一个浏览器扩展/插件的[选项页面](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages)。既不显示地址栏，也不显示重新加载指示器。所以我看不到任何东西…本来可以在一个额外的选项卡中打开页面进行调试，至少，从回顾的角度来看，我应该这样做，但当时我没有这样做。了解重载行为会使事情变得容易得多，因为我不必去猜测是哪个奇怪的浏览器错误触发了应该只在页面加载时运行的 JS 代码。

还要注意我的页面足够快和简单，所以我看不到任何重载的视觉指示。

### 那么为什么在移除所有 JS 的时候还有效呢？

移除所有的 JS 应该已经测试了错误是否仅仅是由 HTML 引起的——正如我们现在所知道的，实际上是这样的。然而，它向我指出了相反的方向:这个 bug 不再明显，让我认为这个 bug 在我的 JS 代码中。

原因是我显然删除了所有的 JavaScript 代码。因此，重新加载时触发的代码(init 代码)向我展示了错误的视觉线索(不同的消息),也被删除，不能触发。😆所以网站仍在重新加载，但我再也看不到重新加载了，因为我也删除了重新加载时会触发的代码。

### 那么为什么其他的按钮会起作用呢？

这让我抓狂的部分原因是，在页面的另一部分，我用完全相同的方式在 click 事件处理程序上附加了完全相同的按钮。

然而，据我现在所知，所有这些按钮在语义上都是提交按钮，因为我总是错过`type="button"`。尽管如此，它们没有触发重载，因为它们没有包含在`form`标签中。因为我还没有提到:显然，只有当我在一个`form`标签中时,“提交”按钮才能“提交”表单。没有它，浏览器会默默地忽略语义无效的按钮… arrgh…
这就是为什么其他按钮不会触发重新加载。

### 怪不怪 spec？

文章描述已经指出了，不是吗？实际上，尽管情况很糟糕，我也直接走向了错误的方向，但我还是部分相信。为什么我必须*明确定义*一个按钮没有功能？为什么我必须定义一个按钮是一个按钮？为什么它默认有一个功能？尤其是以这样一种隐蔽的方式…

### 这是在/关于什么项目？

这是我的一个附加组件中的一个新特性的选项页中的一个问题[。](https://github.com/rugk/awesome-emoji-picker/pull/10)