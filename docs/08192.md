# 将虚拟机迁移到 Azure 开发测试实验室

> 原文:[https://dev . to/documented nerd/migrating-VMs-to-azure-dev test-labs-4kb 6](https://dev.to/documentednerd/migrating-vms-to-azure-devtest-labs-4kb6)

这是我经常遇到的事情，它的核心是成本管理。没有人愿意花不必要的钱，尤其是当你在云中运行你的解决方案的时候。对于大多数组织来说，运行较低的环境可能是一个很大的成本因素。

所以情况是这样的，你有一个虚拟机，可以是开发人员的机器，也可以是某种形式的低级环境(开发、测试、QA 等)。简单的事实是，您必须为这个环境付费，以便能够运行测试，并确保在部署到生产环境时一切正常。因此，如果你坚持 DevOps 原则的话，这是一个不可避免的罪恶，也是极其重要的。不幸的是，你可能只会在工作时间使用这些较低的环境。他们可能没有暴露在外面的世界，他们可能也没有受到顾客任何形式的攻击。

因此，最终，这意味着您要为这个环境支付 24/7 的费用，但每天只使用 12 个小时。这意味着你基本上是在为你所需要的东西付双倍的钱。

进入 [DevTest Labs](https://azure.microsoft.com/en-us/services/devtest-lab/) ，它允许您创建虚拟机和工件，从而轻松启动和关闭环境，无需您付出任何努力，因此您可以节省运行这些较低环境的成本。

现在，最大的问题变成了，“这很好，但我如何将现有的虚拟机迁移到新的 DevTest 实验室，我该怎么做？”答案是可以通过脚本来实现，我已经为此写了一个脚本。

```
#The resource group information, the source and destination resourceGroupName="\<Original Resource Group\>" newResourceGroupName="\<Destination Resource Group\>" #The name of the VM you wish to migrate vmName="\<VM Name\>" newVmName="\<New VM Name\>" #The OS image of the VM imageName="Windows Server 2016 Datacenter" osType="Windows" #The size of the VM vmsize="\<vm size\>" #The location of the VM location="\<location\>" #The admin username for the newly created vm adminusername="\<username\>" #The suffix to add to the end of the VM osDiskSuffix="\_lab.vhd" #The type of storage for the data disks storageType="Premium\_LRS" #The VNET information for the VM that is being migrated vnet="\<vnet name\>" subnet="\<Subnet name\>" #The name of the lab to be migrated to labName="\<Lab Name\>" #The information about the storage account associated with the lab newstorageAccountName="\<Lab account name\>" storageAccountKey="\<Storage account key\>" diskcontainer="uploads" echo "Set to Government Cloud" sudo az cloud set --name AzureUSGovernment #echo "Login to Azure" #sudo az login echo "Get updated access token" sudo az account get-access-token echo "Create new Resource Group" az group create -l $location -n $newResourceGroupName echo "Deallocate current machine" az vm deallocate --resource-group $resourceGroupName --name $vmName echo "Create container" az storage container create -n $diskcontainer --account-name $newstorageAccountName --account-key $storageAccountKey osDisks=$(az vm show -d -g $resourceGroupName -n $vmName --query "storageProfile.osDisk.name") echo "" echo "Copy OS Disks" echo "--------------" echo "Get OS Disk List" osDisks=$(echo "$osDisks" | tr -d '"') for osDisk in $(echo $osDisks | tr "[" "\n" | tr "," "\n" | tr "]" "\n" ) do echo "Copying OS Disk $osDisk" echo "Get url with token" sas=$(az disk grant-access --resource-group $resourceGroupName --name $osDisk --duration-in-seconds 3600 --query [accessSas] -o tsv) newOsDisk="$osDisk$osDiskSuffix" echo "New OS Disk Name = $newOsDisk" echo "Start copying $newOsDisk disk to blob storage" az storage blob copy start --destination-blob $newOsDisk --destination-container $diskcontainer --account-name $newstorageAccountName --account-key $storageAccountKey --source-uri $sas echo "Get $newOsDisk copy status" while ["$status"=="pending"] do status=$(az storage blob show --container-name $diskcontainer --name $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.status') status=$(echo "$status" | tr -d '"') echo "$newOsDisk Disk - Current Status = $status" progress=$(az storage blob show --container-name $diskcontainer --name $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.progress') echo "$newOsDisk Disk - Current Progress = $progress" sleep 10s echo "" if ["$status" != "pending"]; then echo "$newOsDisk Disk Copy Complete" break fi done echo "Get blob url" blobSas=$(az storage blob generate-sas --account-name $newstorageAccountName --account-key $storageAccountKey -c $diskcontainer -n $newOsDisk --permissions r --expiry "2019-02-26" --https-only) blobSas=$(echo "$blobSas" | tr -d '"') blobUri=$(az storage blob url -c $diskcontainer -n $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey) blobUri=$(echo "$blobUri" | tr -d '"') echo $blobUri blobUrl=$(echo "$blobUri") echo "Create image from $newOsDisk vhd in blob storage" az group deployment create --name "LabMigrationv1" --resource-group $newResourceGroupName --template-file customImage.json --parameters existingVhdUri=$blobUrl --verbose echo "Create Lab VM - $newVmName" az lab vm create --lab-name $labName -g $newResourceGroupName --name $newVmName --image "$imageName" --image-type gallery --size $vmsize --admin-username $adminusername --vnet-name $vnet --subnet $subnet done dataDisks=$(az vm show -d -g $resourceGroupName -n $vmName --query "storageProfile.dataDisks[].name") echo "" echo "Copy Data Disks" echo "--------------" echo "Get Data Disk List" dataDisks=$(echo "$dataDisks" | tr -d '"') for dataDisk in $(echo $dataDisks | tr "[" "\n" | tr "," "\n" | tr "]" "\n" ) do echo "Copying Data Disk $dataDisk" echo "Get url with token" sas=$(az disk grant-access --resource-group $resourceGroupName --name $dataDisk --duration-in-seconds 3600 --query [accessSas] -o tsv) newDataDisk="$dataDisk$osDiskSuffix" echo "New OS Disk Name = $newDataDisk" echo "Start copying disk to blob storage" az storage blob copy start --destination-blob $newDataDisk --destination-container $diskcontainer --account-name $newstorageAccountName --account-key $storageAccountKey --source-uri $sas echo "Get copy status" while ["$status"=="pending"] do status=$(az storage blob show --container-name $diskcontainer --name $newDataDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.status') status=$(echo "$status" | tr -d '"') echo "Current Status = $status" progress=$(az storage blob show --container-name $diskcontainer --name $newDataDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.progress') echo "Current Progress = $progress" sleep 10s echo "" if ["$status" != "pending"]; then echo "Disk Copy Complete" break fi done done echo "Script Completed" 
```

所以上面的脚本分成几个关键部分。第一部分是以下部分需要发生的情况:

*   创建目标资源组
*   取消分配机器
*   为要迁移到的磁盘创建容器

```
echo "Create new Resource Group" az group create -l $location -n $newResourceGroupName echo "Deallocate current machine" az vm deallocate --resource-group $resourceGroupName --name $vmName echo "Create container" az storage container create -n $diskcontainer --account-name $newstorageAccountName --account-key $storageAccountKey 
```

下一个过程是确定虚拟机的操作系统磁盘，并将该磁盘从其当前位置复制到与 DevTest lab 关联的存储帐户。下一个关键部分是基于该虚拟机创建一个自定义映像，然后基于该映像创建一个虚拟机。

```
osDisks=$(az vm show -d -g $resourceGroupName -n $vmName --query "storageProfile.osDisk.name") echo "" echo "Copy OS Disks" echo "--------------" echo "Get OS Disk List" osDisks=$(echo "$osDisks" | tr -d '"') for osDisk in $(echo $osDisks | tr "[" "\n" | tr "," "\n" | tr "]" "\n" ) do echo "Copying OS Disk $osDisk" echo "Get url with token" sas=$(az disk grant-access --resource-group $resourceGroupName --name $osDisk --duration-in-seconds 3600 --query [accessSas] -o tsv) newOsDisk="$osDisk$osDiskSuffix" echo "New OS Disk Name = $newOsDisk" echo "Start copying $newOsDisk disk to blob storage" az storage blob copy start --destination-blob $newOsDisk --destination-container $diskcontainer --account-name $newstorageAccountName --account-key $storageAccountKey --source-uri $sas echo "Get $newOsDisk copy status" while ["$status"=="pending"] do status=$(az storage blob show --container-name $diskcontainer --name $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.status') status=$(echo "$status" | tr -d '"') echo "$newOsDisk Disk - Current Status = $status" progress=$(az storage blob show --container-name $diskcontainer --name $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey --output json | jq '.properties.copy.progress') echo "$newOsDisk Disk - Current Progress = $progress" sleep 10s echo "" if ["$status" != "pending"]; then echo "$newOsDisk Disk Copy Complete" break fi done echo "Get blob url" blobSas=$(az storage blob generate-sas --account-name $newstorageAccountName --account-key $storageAccountKey -c $diskcontainer -n $newOsDisk --permissions r --expiry "2019-02-26" --https-only) blobSas=$(echo "$blobSas" | tr -d '"') blobUri=$(az storage blob url -c $diskcontainer -n $newOsDisk --account-name $newstorageAccountName --account-key $storageAccountKey) blobUri=$(echo "$blobUri" | tr -d '"') echo $blobUri blobUrl=$(echo "$blobUri") echo "Create image from $newOsDisk vhd in blob storage" az group deployment create --name "LabMigrationv1" --resource-group $newResourceGroupName --template-file customImage.json --parameters existingVhdUri=$blobUrl --verbose echo "Create Lab VM - $newVmName" az lab vm create --lab-name $labName -g $newResourceGroupName --name $newVmName --image "$imageName" --image-type gallery --size $vmsize --admin-username $adminusername --vnet-name $vnet --subnet $subnet done 
```

现在上面的一部分是使用一个 ARM 模板来创建图像。模板如下:

```
{ "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": { "existingLabName": { "type": "string", "defaultValue":"KevinLab", "metadata": { "description": "Name of an existing lab where the custom image will be created or updated." } }, "existingVhdUri": { "type": "string", "metadata": { "description": "URI of an existing VHD from which the custom image will be created or updated." } }, "imageOsType": { "type": "string", "defaultValue": "windows", "metadata": { "description": "Specifies the OS type of the VHD. Currently 'Windows' and 'Linux' are the only supported values." } }, "isVhdSysPrepped": { "type": "bool", "defaultValue": true, "metadata": { "description": "If the existing VHD is a Windows VHD, then specifies whether the VHD is sysprepped (Note: If the existing VHD is NOT a Windows VHD, then please specify 'false')." } }, "imageName": { "type": "string", "defaultValue":"LabVMMigration", "metadata": { "description": "Name of the custom image being created or updated." } }, "imageDescription": { "type": "string", "defaultValue": "", "metadata": { "description": "Details about the custom image being created or updated." } } }, "variables": { "resourceName": "[concat(parameters('existingLabName'), '/', parameters('imageName'))]", "resourceType": "Microsoft.DevTestLab/labs/customimages" }, "resources": [{ "apiVersion": "2018-10-15-preview", "name": "[variables('resourceName')]", "type": "Microsoft.DevTestLab/labs/customimages", "properties": { "vhd": { "imageName": "[parameters('existingVhdUri')]", "sysPrep": "[parameters('isVhdSysPrepped')]", "osType": "[parameters('imageOsType')]" }, "description": "[parameters('imageDescription')]" } } ], "outputs": { "customImageId": { "type": "string", "value": "[resourceId(variables('resourceType'), parameters('existingLabName'), parameters('imageName'))]" } } } 
```

因此，如果您运行上面的代码，它将在 DevTest 实验室下创建新的虚拟机。