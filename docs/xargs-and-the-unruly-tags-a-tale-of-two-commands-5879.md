# xargs 和难以驾驭的标签:两个命令的故事

> 原文：<https://dev.to/hartmann/xargs-and-the-unruly-tags-a-tale-of-two-commands-5879>

当我配置[我的博客的](https://thomashartmann.dev/) CI/CD 管道来标记已部署的提交并将标记推回到回购中时，我认为我真的很聪明，但我很少像我想的那样聪明:我忘记了进行适当的检查以避免这些标记推触发管道的后续运行，事情变得有点… *失控*。

我刚推完一个更新就上床睡觉了，当我起来查看时，我发现部署标记阶段已经运行了一遍又一遍，一遍又一遍…你懂的。谢天谢地，它在大约 130 轮后失败了，所以它可能会更糟，但我*在远程回购中留下了大量无用和不想要的标签。*

那么，如何解决这样的问题呢？是的，来营救了！

## 只要有意愿…

起初，我真的不知道该如何着手。我希望 git 有一些很好的内置功能来批量删除远程标签，但是当我回想起来时发现它确实有(见[the postmody](#postmortem)),我当时找不到它。

然而，因为所有的标签都是针对特定的提交，所以我*知道*可以使用`git tag --contains <SHA>`列出所有相关的标签，并用换行符隔开。

因此，根据 Stack Overflow 和[这个家伙](http://theknarf.com/)的一些有用的建议，我构建了这个小命令，它很好地解决了我的问题:

```
git tag --contains 9216e97ce7e66090f79eba4d1abe6548d72dd638 \
| xargs -I % git push origin :refs/tags/% 
```

现在，我以前遇到过`xargs`，甚至做过从堆栈溢出复制和粘贴的老把戏，但是它看起来总是很复杂，没有人告诉过我为什么我需要它或者它有什么作用；所以我只是在幸福的无知中继续。不过，这次不是。是时候弄清楚到底发生了什么。

## 摸索`xargs`

`xargs`卖给我的方式是:“对一个列表中的每一项执行一个命令”。它实际上比这更强大，但这是一个很好的起点。

让我们使用`man`页面来找出`-I %`位的含义:

`-I`

**replace-str** :"用从标准输入中读取的名称替换初始参数中出现的内容"

用于指示要运行的命令中放置参数的位置的字符串。在上面的命令中，我们选择使用`%`，但是您并不限于此。

类似于一般的`printf`和格式字符串，这会将您的参数放在命令中您想要的位置。在我们的例子中，它既限制了我们一次只能使用一个参数(标签),又允许我们将它附加到`:refs/tags/`而不用空格分隔。

这意味着在上面的代码片段中，`xargs`将为每个列出的标签运行命令`git push origin :refs/tags/<tag_name>`，该命令使用一个空引用来推送标签，从而删除它。

如果您只想将参数放在命令的末尾，您甚至可以不使用`-I`。假设您想递归删除一个目录中的所有`.swp`文件:

```
find -name "*.swp" | xargs rm 
```

但是要注意，在不使用`-I`或`-n`(限制每个命令使用的参数数量)的情况下，`xargs`会将您给它的列表分割成相当大的块，并每次对命令应用尽可能多的参数。这意味着，在这种情况下，它可能会看起来像这样:

```
rm a.swp b.swp c.swp ... 
```

这通常是好的，也是你想要的，但是要记住这一点，以防万一。

这仅仅触及了`xargs`所能做的表面，但足以让它做一些相当繁重的工作。它可能不是经常需要的东西，但是当你需要它的时候，它是你腰带上的一个很好的工具。

## 死后的

现在，你可能已经注意到，我对我删除的每个标签都做了一个`git push`，你可能会想，对于一百多个标签，这一定要花相当长的时间。你可能是对的。幸运的是，我正在做别的事情，所以我可以很高兴地让它在后台运行。但是我们可以做得更好！

`xargs`有一个选项`-P`或`--max-procs`，您可以用它来决定并行运行多少个进程。默认值为 1，但是如果您将其设置为 0，它将尽可能多地运行。假设 git 允许我们同时从同一个 repo 运行多个`push`操作，这可以节省我们相当多的时间。但是有一个更好的方法:

如[堆栈溢出响应](https://stackoverflow.com/a/12791414)中所述，您可以在`git push`中使用空格分隔的标签名称列表(`<tags>`);因此，我们可以运行`git push --delete origin <tags>`来获得与逐个删除它们相同的结果。

如果我们重写之前的命令，我们可以简化它*和*只需一次推送:

```
git tag --contains 9216e97ce7e66090f79eba4d1abe6548d72dd638 \
| xargs git push --delete origin 
```

…是的，那样会更有效率😅