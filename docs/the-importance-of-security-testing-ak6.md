# 安全测试的重要性

> 原文：<https://dev.to/just_insane/the-importance-of-security-testing-ak6>

周末在我的实验室安装一个新的 Keycloak 客户端时，我发现了一些奇怪的事情，我的 Keycloak 数据库中有一些不应该在那里的用户。

#### 背景:

在我的 homelab 环境中，我一直使用 [Keycloak](https://www.keycloak.org/) 来保护我的服务，或者直接用于 Nextcloud、Confluence 和吉拉等应用程序，或者通过经过认证的反向代理间接用于其他应用程序，如哈希公司的[consult](https://www.consul.io/)或 [Jupyter](https://jupyter.org/) 等单页面应用程序。这是一个很好的设置，让我可以从任何地方轻松安全地访问我的内部应用程序，在不同服务之间移动时可以进行 2FA 和无缝访问。至少我是这么认为的。

#### 发现:

在我的 Keycloak 用户列表中发现一些奇怪的用户后，我决定做一些调查。我知道我最初允许注册非常封闭的服务，如只读访问 Confluence 的部分内容，以及我在吉拉的内部问题跟踪器。这些用户在 Keycloak 中被设置了一个默认的角色，叫做外部用户，这个角色对我的网络上的服务有非常有限的访问权限。

为了好玩，我决定创建一个新用户，看看可以访问什么。我打开了一个新的私有窗口，这样我可以确保我没有使用来自我的认证会话的 cookies，然后开始创建一个新用户。我很高兴地看到了一个 [Duo](https://duo.com/) 页面(Duo 是一个 2FA 提供商，您可以与之集成以保护许多不同的服务)，直到我意识到有一个选项可以将自己注册为 Duo 的用户。这时我意识到有一个问题。

#### 破口:

在 Duo 注册了新用户后，我开始四处闲逛，先去了 Confluence 和吉拉，看到自己仍然有有限的权限，有点释怀。然后我去了 Consul，页面直接打开到主应用程序，显示我所有的服务愉快地嗡嗡作响。接下来我去了 Jupyter，并立即看到了创建新的 shell 会话的选项。

#### 遏制:

一旦我能够访问 Jupyter，我就禁用了 Keycloak 上的注册，清除了未知用户(其中一些使用了合法的电子邮件)，并设置 Duo 不允许用户自己注册。我还确保 Keycloak 中没有活动的会话，并开始锁定我的网络，以确保没有人仍然在外围。

#### 根本原因:

这个问题的根本原因是我的反向代理。知道我的大部分应用程序都在它后面得到了保护，尤其是那些不处理自身认证的应用程序，我就把它拆开了。我不用看多远就能发现我的错误。

几乎所有我代理的服务在服务器部分都有这个块(私人信息省略):

```
access_by_lua '
 local opts = {
 discovery = "$URL/.well-known/openid-configuration",
 redirect_uri_path = "/redirect_uri",
 redirect_uri_scheme = "https",
 client_id = "OpenResty",
 ssl_verify = "no",
 client_secret = "$ClientSecret",
 session_contents = {id_token=true}
 }
 local res, err = require("resty.openidc").authenticate(opts)

if err then
 ngx.status = 403
 ngx.say(err)
 ngx.exit(ngx.HTTP_FORBIDDEN)
 end
'; 
```

让我们把它分解一下，好吗？

我的反向代理是 OpenResty，一个修改的 Nginx 服务器设置来运行 Lua。在 CentOS7 上，你必须从源代码构建 Nginx 来添加 OIDC 认证插件，在 OpenResty 中，它是内置的。

首先，我们为 OIDC 身份验证定义一些选项:

1.  openid 配置信息的 URL
2.  重定向到的路径，这是后端应用程序中不存在的 URI，应该在使用 Keycloak 进行身份验证后重定向到该路径，以便代理可以检查身份验证
3.  重定向方案
4.  Keycloak 客户端 ID
5.  是否应该验证密钥锁的 SSL(应该设置为是)
6.  你从奇洛克那里得到的客户秘密
7.  会话内容，在这种情况下，我们只是寻找 id_token
8.  身份验证检查，下面将详细介绍
9.  如果有错误该怎么办，在这种情况下，发送 403，打印错误，并设置 HTTP_FORBIDDEN，然后退出

查看身份验证检查，您发现问题了吗？它只是检查访问受保护资源的人是否通过了 Keycloak 的身份验证。它不检查他们的组、角色，甚至不确保他们在域中有有效的电子邮件地址。

因为任何人都可以注册 Keycloak，任何人都可以在 Duo 中注册，他们将被认证，因此将自动通过检查，允许任何人尝试访问这些内部应用程序。

#### 情况变糟了:

知道我已经在 Keycloak 中设置了外部身份提供者，比如脸书和谷歌(在 Keycloak 中添加外部身份提供者可以让人们使用其他服务登录，这些服务可以处理他们自己的身份验证)，我回去测试了这些。

我关闭了当前的私人窗口，打开了一个新窗口，回到我的领事网址，点击谷歌的登录按钮。当系统提示时，我输入了一个备用的电子邮件地址和密码，一旦我通过了谷歌验证，我就被重定向回 Keycloak，然后到了主领事页面。

在签入 Keycloak 后，我没有看到用这个邮件创建的新用户。因为身份验证是由 Google 处理的，所以 Keycloak 关心的只是用户是否成功地通过了 Google 的身份验证，并且只是将用户作为在 Keycloak 中经过身份验证的用户传递回代理。

不仅任何人都可以在 Keycloak 中注册一个帐户，并将自己添加到 2FA 中，他们还可以完全绕过这些步骤，而不会引起怀疑，也不会创建任何用户记录。

#### 吸取的教训:

我从这件事中学到了很多，首先是要经常仔细检查每件事，尤其是与安全相关的事情。如果我在最初设置时检查了这些身份验证流程，我会更快地发现这些问题，这就不会成为问题。

其次，充分理解和阅读文档很重要。通过在 OpenResty 中添加更多检查、在 Keycloak 中禁用注册或第三方身份验证，或者在 Duo 中阻止用户自助注册，可以轻松缓解或完全防止这种情况。

第三，检查一切。如果您启用了某个功能，请确保该功能完全符合您的预期。如果没有，最好禁用它，或者弄清楚它为什么这样做。

#### 结论:

我搞砸了，非常糟糕。幸运的是，这是在测试环境中，而不是在生产环境中，我的网络上没有任何过于敏感的东西。

这是一个我不会忘记的错误，我将在我的职业生涯中带着它。

我所使用的工具，甚至是工具的组合都没有内在的问题，这纯粹是我的配置问题。我仍然 100%推荐这篇文章中提到的所有工具，并打算继续使用它们。我对它们有了更多的尊重，并打算在未来使用它们来进一步保护我的网络。

#### 未来的想法:

当我重建我的实验室，专注于 Kubernetes 和零信任网络设计时，我在这里学到的经验将指导我确保一切尽可能安全。