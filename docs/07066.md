# API 中的版本控制

> 原文：<https://dev.to/dwd/versioning-in-apis-22bj>

这是 1991 年的平安夜。在世界各地，孩子们正兴奋地达到狂热的程度。许多成年人也充满热情。

但马克·克里斯平不是。相反，他向“ietf-822”邮件列表发送了一封详细的电子邮件，详细说明了新提议的`MIME-Version`头字段有什么问题。他说，目前的形式几乎无法使用。他问道，如果你得到的是另一个版本的`1.0`，你该怎么办？“这是什么意思？？?"他问，在一个罕见的全大写爆发。

他最后说，如果社区需要改变版本，他们最好制定一个全新的协议——他将竭力反对任何仅仅改变版本号的举动。

[马克的咆哮](https://www.mhonarc.org/archive/html/ietf-822/1991-12/msg00137.html)

## 哑剧简史

这里需要绕道。

MIME，或更正式地，多用途因特网邮件扩展(或“多媒体”)；像许多 IETF 首字母缩略词一样，扩展随着时间的推移而改变)是在 20 世纪 90 年代早期创建的，作为“改进”互联网邮件的通常任意的方法的替代。

与之竞争的提案，如 X.400，有比互联网纯文本更丰富、更复杂的信息格式。Unicode 的概念还没有出现，但是不同字符集和不同表示方式的想法肯定出现了——但是，互联网邮件只支持 ASCII。专有的电子邮件协议——有很多——也支持丰富的多媒体消息。更广泛的社区引入了令人兴奋的东西，如“uuencode”和“binhex ”,以解决这种缺乏。

因此，在整个 20 世纪 90 年代早期，人们齐心协力将互联网邮件扩展到包括所有这些类型的丰富的消息格式的文本、图像和附件。

大约四五年后，当我开始使用电子邮件时，哑剧是热门的新事物，我们中的许多人不得不煞费苦心地学习如何阅读电子邮件。

MIME 继续成为网络多媒体的基础——HTTP，尽管开始时是一个“超文本传输协议”,但更好的名称是“MIME 传输协议”。作为 web 和电子邮件两者的核心——迄今为止使用最广泛的两个应用级协议——MIME 可以说是历史上使用最广泛的设计。

自从哑剧被设计出来到现在已经将近 30 年了——整整 30 年。也许现在下结论还为时过早，但看起来马克是对的。

仍然强制包含`MIME-Version: 1.0`。

## 协议和 API

好了，到目前为止，我已经提到了“版本”，但没有提到“API”。

当我们年轻的时候，我们称 API 为“协议”。如今，这个词似乎是为处于社会底层的人保留的。然而，设计原则保持不变。适用于 HTTP 甚至 IP 设计的东西同样适用于你的博客 API。

所以原谅我有点老套，任何时候看到“协议”，只要能让你更开心就当“API”读吧。

## 一个全新的世界

我承认，我最近没有处理过电子邮件。但我敢打赌，尽管这是强制性的，但没人会检查哑剧版本。正如马克多年前所说的，如果检查失败了，你会怎么做？

Mark 认为，由于对 MIME-Version 的任何改变都将是一个突破性的改变，所以最好的解决方案是一个全新的协议。因为 MIME 被定义为一组头字段，所以您只需使用不同的头字段。MIME 使用——除了它的`MIME-Version`——一组以`Content-`开始的头字段。马克建议我们应该换成类似`Body-`的东西——彻底决裂。

其结果是，在任何语义意义上，你都没有“改变版本”，你完全“改变了协议”。有时候，解决这个问题的最好方法确实是在任意数字后调用您的协议——但是不要欺骗自己说这些是任何有用意义上的“版本”。

因此，如果你已经将你的协议根植于`/blogging/v1/`并且你想要改变一些关键的东西，你将把一切都改变到`/blogging/v2/`——并且所有老的客户端将会中断(或者继续使用旧的协议，也许永远)。期望每台客户机和每台服务器都立即改变被称为“叉车式升级”——从这些东西被放进你需要物理改变的硬件开始——通常被认为是一件坏事。

## 分机

你们当中明眼人会注意到，哑剧也没有停止使用`Content-Type`和朋友。然而，MIME 在 1992 年原始 RFC 发布后并没有停止开发。新的 RFC 随后在 1993 年和 1996 年发布了两次，并在 1997 年开发了全新的功能，如交流演示信息。

这些都依赖于规则一:

*   接收者忽略他们不理解的额外内容。

用 JSON 的术语来说，如果从 API 返回的对象有一些新的额外的键，不用担心。他们不重要。

许多 X.nnn 协议及其衍生协议对此做了一点修改，允许发送者声明一个扩展是否是关键的。关键扩展，如果不被理解，意味着消息作为一个整体不被理解，并产生一个错误。非关键扩展可以被简单地忽略。

IMAP，Mark Crispin 的互联网邮件访问协议，是围绕一个没有改变的规则一建立的。服务器可以添加数据(在特定的地方——很多 IMAP 的结构都是位置性的)而不会产生不良影响。IMAP4rev1 从 1996 年开始使用。

XMPP 完全是围绕规则一构建的。客户端和服务器经常丢弃它们不理解的流量。事实上，服务器通常不理解它们在客户端之间转发的所有流量。XMPP 从 1999 年就开始使用了(现在仍然是 1.0 版本)。

事实上,“端到端原则”是规则一的一个特例——不是端点的接收者只是不加改变地传递数据。

HTTP 有一段曲折的历史——HTTP/0.9 和 HTTP/1.0 都是在通常的专家库之外设计的，结果都受到了影响。HTTP/1.1 在很大程度上与 HTTP/1.0 交叉兼容，但修复了大多数问题。HTTP/2.0 是一个彻底的重新设计。HTTP/1.0 中的版本协商实际上从未在实践中使用过——所有的更改都是通过规则一或协商进行的。

## 谈判

有时候知道你要发送的流量是否会被接收者理解是很好的。其他时候，您希望告诉接收方发回额外的数据。

这个问题的解决方案仍然可以是一个版本——但同样，这是一个叉车，一个全有或全无的二元开关。

相反，保持开关较小。IMAP 开创了一种模型，在这种模型中，服务器公布“功能字符串”,客户机解析这些字符串，或者协商特定的选项，或者只知道它们可以使用特定的功能。您可以将这些视为显式或隐式协商——使用哪一种取决于特性的复杂性以及您可以忍受的往返次数。

类似地，在 XMPP 中，任何实体——客户机或服务器——都可以询问其他任何实体它支持什么，然后进行显式或隐式协商。尽管如此，在大多数情况下，“使用它，看看它是否有效”的策略是很好的——一种单方面的隐性谈判，如果你愿意的话——或者“吸它，看看”。

基于 HTTP 的协议——像 REST APIs 不太适合复杂的协商，但是规则一和隐式协商都很好。概述端点可用于提供服务器端功能和初始端点，请求可使用头字段或参数来指示支持的功能并请求使用它们。当然也可以借用 X.nnn 的“临界扩展”。

如果操作得当，单个服务器和客户机可以完全独立地升级。

不要认为因为它是 HTTP，你的客户端代码是从你的站点下载的，所以没关系——如果它是公共 API，那就不是真的，如果它是私有 API，如果你的站点很好，人们仍然会让他们的浏览器一直开着。

## 又一次版本

你现在拥有的不是一个单一的、版本化的协议，而是几十个小的、专门的协议。举个简单的例子，一个博客协议可能有一个帖子协议，另一个评论协议。帖子可能包含一组内容部分，图像可能与文本完全不同。

通常，使这些适应新需求的最佳方式是添加新特性，要么遵循规则一，要么根据需要通过协商。但是一个全新的扩展的成本比一个全新的协议的成本要小得多，而且由于“命名事物”仍然是计算机科学中两个最困难的问题之一(与高速缓存无效和一个错误之外)，那么用一个简单的版本号命名协议确实很有意义。

在 XMPP 中，协议扩展通过 XML 名称空间工作——不严格地说，我们通过 URI 命名协议。对于官方扩展，我们使用包含版本号的 URN 表单。每个新版本都是一个完全不同的协议——理解“urn:xmpp:mam:0”的客户机根本不能理解“urn:xmpp:mam:1”——但是服务器可以很容易地支持这两种协议，并且在过渡时期经常这样做。

很多时候，我们能够以一种不会强加给我们“名称空间碰撞”的方式合并变更。许多协议扩展在“版本 0”上度过了它们的整个开发周期。有时，这是对 XML 名称空间的可怕滥用——注意，我们任意地改变 XML 模式，知道在实践中，事情只是工作。但偶尔，我们需要做出突破性的改变。

因此，尽管避免更改版本是值得的，即使是在扩展级别，但至少如果您确实需要这样做，那么它的细粒度是非常有用的。

但是请记住，这与使用一个不同的、全新的协议没有什么不同。对于 REST APIs，将“v1”更改为“v2”与以任何其他方式更改端点 URI 没有什么不同。

## 但它们不是版本

真实版本——像现在所谓的“语义版本化”(多年来一直用于版本化),包含各种关于向后兼容性的信息等等。

这些对于软件库版本控制非常有用和有效，并且有一种假设这种模型对于协议也很有效的诱惑。

事实并非如此。

MIME 的证据是，一个成功的、设计良好的、可扩展的协议永远不会改变版本——而协议可扩展性和功能协商可以使一个简单的设计持续几十年。

在过去的几十年中，具有特征协商的可扩展协议模型已经被开发和改进了许多次。作为一个概念，它始终经受住了时间的考验。

当然，你可能不会设计出能持续几十年的协议或 API。但是就像你应该对软件库使用语义版本控制一样，即使你不打算在几十年内维护它们，你也应该理所当然地设计可扩展的协议。