# Rails 6 升级最佳实践

> 原文：<https://dev.to/hint/rails-6-upgrade-best-practices-5934>

*原贴于* [*提示的博客*](https://hint.io/blog/rails-6-upgrade-best-practices) 。

Rails 6 指日可待，6.0.0.rc1 于 4 月下旬发布。你的应用程序为最新版本的 Rails 做好准备了吗？遵循这些最佳实践，尽可能顺利地进行升级。

## 制定计划

任何升级的第一步都应该是确定您当前的 Ruby 和 Rails 版本，然后收集关于您的代码、测试套件及其依赖关系的数据。您计划的一部分是决定升级前可以做什么，升级后可以做什么。您总是希望限制变更的范围，所以当错误发生时，确定导致错误的变更要简单得多。

*注意:*我们建议尽早迁移到新的 Rails 规范。太多的团队选择推迟这些迁移，这通常意味着直到他们被下一次主要的 Rails 升级所逼，他们才会回来。

### 红宝石和铁轨

Rails 5.x 需要 Ruby 2.2.2 或更新版本，而 Rails 6.x 需要 Ruby 2.5.0 或更新版本。从你的项目中运行`ruby -v`,看看你的应用程序在哪个版本的 Ruby 上。如果你使用的是旧版本，那么你需要在升级 Rails 之前升级 Ruby。

Rails `5.2.3`是[当前的稳定版本](https://rubygems.org/gems/rails/versions)。我们建议在进行下一步升级之前，升级到您的应用所在的次要版本的最新补丁版本。例如，如果你的应用在`5.2.0`上，那么你将更新到`5.2.3`。应该不会有任何问题，使这个补丁更新，因为补丁版本只是错误和安全修复。Rails 核心团队表示，他们将对 API 和特性进行修改以进行安全修复，因此这就是验证最新补丁版本的原因。

### App 回顾

当审查你的应用程序时，首先要做的事情之一是检查生产日志中的任何弃用警告。多年来，Rails 核心团队已经实施了一个强有力的弃用策略，因此在升级之前清除这些警告非常有用。许多 gem 开发者已经实现了类似的弃用政策，所以在做这项工作的时候不要忽略那些。

*注意:*我们经常看到人们在生产和测试环境中禁用了弃用警告。如果您在这些日志文件中看不到任何反对意见，请持怀疑态度。

审查任何 monkey 补丁，因为它们很可能需要修改才能与下一版本的 Rails 一起工作。这是研究新的 Rails APIs 来决定是否有 Rails 方法来替代它们的大好时机。

寻找任何未记录的 Rails 方法的使用。Rails 核心团队认为任何未记录的方法都是私有的，可以随时更改。如果您发现了任何问题，请务必查看下一版本 Rails 中的变化。这是一个很好的时机来决定这段代码是否是当前必需的，或者你是否应该用一个更可靠的解决方案来代替它。

### 测试套件

当执行升级时，可靠的自动化测试套件是非常宝贵的；测试确保您的应用在升级前后以相同的方式执行。

涵盖了多少行代码？获取您最新的覆盖率统计数据，并寻找漏洞。测试覆盖率并不是一切，但它是一个帮助确保你的代码路径被你的测试套件执行的标准。您的测试套件不仅仅验证所需的更改是否返回相同的结果，它还会测试应用程序的代码路径，这些代码路径会弹出反对警告。如果您的测试覆盖率很小或很低，或者您通常对套件不太有信心，那么现在是投资加强它的时候了。

### 宝石依赖

在你的`Gemfile`中，许多惊喜可能正潜伏着。要清楚地了解哪些依赖项需要随 Rails 一起升级，最好的方法是使用 Bundler 逐步完成升级，目标是成功构建。

假设您的应用程序目前被锁定在 Rails `5.1.7`。你升级到 Rails 6.0 的第一步是将 Rails 升级到`5.2.3`(目前是`5.x`系列的最新版本)，然后运行`bundle update rails`。

Bundler 将尝试将该应用与 Rails `5.2.3`捆绑在一起，但很可能需要更新其他 gem。

Bundler 的输出可能令人望而生畏，但是为了简洁起见，我们假设需要更新的一个 gem 是`devise`。一旦你找到兼容版本的`devise`，你继续运行`bundle update`，根据需要将每个宝石添加到列表中，直到你得到要捆绑的应用。一旦它被捆绑在`5.2.3`上，你将遵循同样的模式升级到 Rails 6.0。

现在您已经有了依赖路线图，是时候回顾一下哪些 gem 现在可以升级并投入生产了。对于 gem 来说，这一点尤其重要，因为 gem 需要改变语法来独立于 Rails 升级进行升级。如果 gem 不需要升级，那么现在是*而不是*升级 gem 的时间，并且应该将其添加到升级后的项目列表中。

### 升级前计划

既然您已经收集了所有数据，那么让我们回顾一下在开始实际升级之前应该解决的一些问题。这些步骤中的每一步都应该分别通过您的产品发布流程。

1.  将 Ruby 升级到 Rails 目标版本的兼容版本
2.  将 Rails 更新到当前的补丁版本
3.  解决所有弃用警告
4.  确保 monkey 补丁或私有 Rails 方法调用的兼容性
5.  在需要的地方扩展测试套件
6.  回顾您的 gem 依赖路线图，升级与您当前版本的 Rails 兼容的 gem

## 铁轨升级

升级前工作完成并投入生产后，是时候开始升级 Rails 了。

### 捆绑并引导

第一步是使用依赖路线图作为指南，让应用程序与下一版本的 Rails 捆绑在一起。一旦它被捆绑，你需要努力让应用程序启动。我们通常会尝试运行测试套件，因为这将用于迭代支持下一版本 Rails 所需的更改。

在这一点上，可能会有由于配置而导致的错误，必须对配置进行更改以与新版本的 Rails 兼容。官方的[升级 Ruby on Rails](https://guides.rubyonrails.org/upgrading_ruby_on_rails.html) 指南是寻找这些所需的 Rails 配置变更的好地方。

### 迭代，迭代，迭代

现在，您可以开始重复您目前无疑会遇到的许多测试失败。从低级别的测试开始，比如单元规格，直到浏览器规格，你会从中受益。接下来，解析测试套件的输出，并根据要同时修复的相似类型对故障进行分组。在迭代测试套件时，帮自己一个忙，用冗长的提交消息进行小的提交。当你有一个生产错误，并且你需要知道为什么你必须在第一时间做出改变时，像`fixed spec`这样的提交消息是没有用的。

一旦您有了一个绿色的测试套件，您就可以继续清除弃用警告了。再次，解析测试套件的输出，并按类型对反对意见进行分组——然后开始对它们进行迭代。

随着绿色测试套件和弃用警告的清理，是时候按照您的过程将新代码投入生产了！！！

## 升级后计划

在升级进入生产阶段并且解决了所有问题之后，是时候回到您之前搁置的项目上了。在可能的情况下，选择加入新的配置，迁移到 Rails 的新工具和特性(ActionText、Webpacker、parallel testing)，并尽可能将 gems 更新到最新版本。

如果您更愿意专注于发布功能，让我们制定一个计划，扩展您的测试套件，或者执行整个升级。[联系 UpgradeRails.com 的我们](https://www.upgraderails.com),告诉我们有关您的升级的更多信息。