# 一个低年级学生、一个中等年级学生和一个高年级学生走进一家酒吧

> 原文:[https://dev . to/anabella/a-junior-a-mid-a-senior-dev-walk-into-a-bar-414 f](https://dev.to/anabella/a-junior-a-mid-and-a-senior-dev-walk-into-a-bar-414f)

聚集在一起，让我告诉你们我和我的队友拿下该平台最关键的服务之一的事情。

为了叙述方便，我将我的同事命名为 S(高级)和 M(中级),尽管我更改了日期和一些技术细节，以尽可能保持匿名。

* * *

那是七月底一个可爱的星期四下午。天气比前几天温和，我和我的队友刚刚搬进办公室的新空间。

生活基本上是美好的。

在我们最资深的开发人员`S`缺席的情况下，前一周已经过去了，但是`M`和我已经设法独立完成了一些任务。

我们引入的变化有一些相当沉重的东西(新的数据库字段，新的端点)，所以我们决定在合并它们之前等待 S 的审查。

## [](#database-changes-and-migrations)数据库变更和迁移📚

与此同时，另一名开发人员审查了我们的更改，并提到我们的迁移脚本中的操作可能会给数据库服务器带来大量工作，并且可能会使它暂时被锁定。所以他提出了一些替代方案。

如果您不知道什么是**数据库迁移**，它是一系列 SQL 脚本，当顺序执行时，从头开始创建整个数据库模式(表、列、默认值、约束等)。).通常它们会在每个部署上运行，但只有在有新的应用时才会运行——即从未运行过的新迁移脚本。

我们不想将我们的变更作为一个迁移来运行，因为那样的话，它将由我们的持续集成系统来执行，如果出现问题，这将完全脱离我们的控制。

我们必须手动运行它。

因此，我们坐下来使用生产数据库的副本，并开始尝试查询，试图找到最有效的替代方案。

这很有趣，我们三个人试图猜测当我们分别运行每个脚本行时会发生什么。会花很长时间吗？还是瞬间跑路？为什么呢？我们应该在哪里设置默认值以防止新条目破坏它？

## [](#showtime)表演时间！👯‍♀️

现在是下午 5 点，我们终于对我们的查询满意了。它按正确的顺序做每件事，并没有真正锁定很长时间。我们给基础设施团队发了一张票，让他们直接在我们的服务器上运行，因为显然我们没有这样做的凭证。过一会儿你就会明白为什么了。

Infra 在这方面真的很努力。我们知道他们是一群忙碌的人，如果他们需要一段时间来做事情也没关系。但这次没有，哦不，这次我还没来得及眨两下眼，票就被关了。

一切似乎都很好。这几乎是一天的结束，所以我们分成自己的办公桌，完成了一些任务。

几分钟后，另一个团队的一名成员过来问我，我们是否要对那个特性进行修改，因为它抛出了一些错误。这像冰桶挑战一样打击了我:

> 哦不，我是说，是的…我们搞砸了。

你能猜到发生了什么吗？我知道发现遗漏比发现错误更难，但是我认为您可以在不了解服务、功能或查询的情况下知道我们需要做什么(以及不需要做什么)。

如果你看到了，请滚动到底部并评论它，我相信你没有偷窥这张照片下面的内容👇

[![_Photo by 胡 卓亨 on Unsplash_](../Images/a15bd5e742f87dbab0776d26c53a774a.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--sP9yEMM3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1600/1%2AK2KPSg2qWPmeomGaybXtPg.jpeg)

好吧，如果你不知道发生了什么，也没关系。我觉得我应该知道，因为这在开发过程中发生过无数次。那天我自己也启动了一个非常相似的功能，处理同样的错误。

准备好了吗？

## [](#reality-hits-hard)现实重创👊

我们在数据库中添加了列*，但是我们没有合并处理这个新数据*的代码。这导致应用程序不知道 WTF 如何处理这些字段，并在所有 GET 请求上抛出错误**😱**

现在，这在一些语言中可能不会发生，它们可能会丢弃额外的、未解析的数据并继续前进。我不应该透露更多关于这方面的信息，但我要说的是，我们使用的技术对流氓数据库列并不感冒，它要求您告诉它如何处理它收到的一切。

不过，没有合并新字段的代码并不是问题。这就是我们邪恶的小坏蛋出现的地方:见见`*`😈*煞星，附和笑声*

看，我们所有的检索查询都使用了`*`(称为星号或星号)，这意味着结果将包括表上的每个字段。这一天，我知道这是一个非常非常糟糕的主意。

如果我们有一个要检索的字段列表，而不是`*`,就不会发生任何不好的事情。但是我们没有。我们三个都知道。它只是被我们遗忘了😰

## [](#the-real-real-problem)真正的、真实的问题🤦🏻‍♀️

好吧，但是，我们是人类，对吗？我们会犯错。没有人能把公司的所有代码都保存在他们的工作记忆中。这就是我们进行测试的原因。不是因为我们的代码脆弱易错，而是因为我们的思想脆弱易错。是我们的大脑创造了代码。

所以问题不在于我们打破了它。问题是没有警报响起。

我们进行了生产测试，但他们没有通知任何人。我们在日志中有错误警报，但是他们没有监视导致最多错误的东西。我们进行了端到端测试，但它们被禁用并标记为“已损坏”。这是真正不可接受的🍋

## [](#epilogue)后记📜

不过，归根结底，这是一个很好的学习机会:你永远不会像失败时那样努力学习。这是一个永远不会离开你的教训。

所以，对你们这些孩子来说，这是我那天学到的东西:

*   不要，我的意思是不要在代码的查询中使用*。就算要写一百个列名，那样更好。
*   害怕数据库的变化，也许恐惧会让你变得谨慎。
*   迁移应该与部署分离，以便对它们提供更好的控制。
*   当您引入数据库更改时，请确保所有代码都已经就绪，并且可以处理以前的数据库状态和更改后的数据库状态。
*   为您的关键特性在生产中运行快乐路径测试，工作并通知正确的人。
*   一旦数据库更改受到影响，就对其进行测试，并在几分钟后监控日志(取决于您获得的流量)。
*   睡觉前刷牙😬

### 讲解员

这是一个由缺乏经验和知识的人物讲述的故事。如果你有任何关于它的意见，来补充或纠正我所说的，我真的很喜欢阅读它，但请对它好一点。🙂

* * *

#### [](#credits)学分

*封面照片由[塞巴斯蒂安·弗莱里奇](https://unsplash.com/photos/8gLBzBob4U8?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)拍摄于 [Unsplash](https://unsplash.com/)*
*照片由[拍摄胡 卓亨](https://unsplash.com/photos/8mZdmmAUCHw?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)on[un splash](https://unsplash.com/)T12】*

*感谢[Nicolas greniéa . k . a . @ pics oung](https://dev.to/picsoung)和 [Eva Casado de Amezua](https://medium.com/@1KHats) 的评论和意见。*
*这个故事最初发表在 [HackerNoon。](https://hackernoon.com/a-junior-a-middle-and-a-senior-dev-walk-into-a-bar-and-they-order-an-alter-table-36d7bf650d33)*