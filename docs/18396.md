# 在 ASP.NET 核心构建更快的后端

> 原文:[https://dev . to/progress telerik/building-faster-back ends-in-aspnet-core-540g](https://dev.to/progresstelerik/building-faster-backends-in-aspnet-core-540g)

虽然 web 应用程序性能调优可能是一件复杂的事情，但是开发人员可以使用一些常识性的技术来简化后端服务器上的流程。让我们来看看一些流行的性能技巧和工具的贸易。

Web 应用程序的性能经常被忽视，直到为时已晚。如果开发人员不小心，小的低效会堆积起来导致缓慢笨重的 web 应用程序。为了避免这种命运，关键是一致性——并且始终意识到性能瓶颈。随着时间的推移，许多小的改进比试图在项目结束时把它们塞进去更便宜也更容易。

我们最近研究了如何在 ASP.NET 核心中构建[更快的前端。现在让我们看看等式的另一半 web 服务器后端。优化后端性能不同于优化前端 web 应用。大多数前端性能改进都集中在网络上请求的大小上。另一方面，后端性能更关注高效地获取数据和控制响应。本文深入探讨了后端性能调优——我们来看看一些有用的行业工具和常用技术。](https://dev.to/progresstelerik/faster-frontends-in-aspnet-core-23ll-temp-slug-6957804)

## [](#measuring-speed)测量速度

如果你想提高你的 web 应用程序的性能，你必须首先测量它。衡量业绩可能是一件棘手的事情。由流水线中的其他过程引起的变化会使精确的性能数据难以获得。开发人员需要知道永远不要相信单一的性能数字。如果您在相同的条件下运行相同的操作几次，您将获得一个足以优化的范围。此外，有些性能问题只有在用户负载下运行应用程序时才能发现。

为了测量性能，开发人员可能想要使用两种不同类型的工具。首先是测量个人表现的剖析工具。有许多工具可以做到这一点，但最流行的工具之一是 [MiniProfiler](https://miniprofiler.com/) 。MiniProfiler 只是一个 NuGet 包，您可以将它放入您的 web 应用程序项目中。它测量不同进程的性能，并在您运行应用程序时显示信息。时间不引人注目地储存在右上角。您可以展开它们，以获得不同进程在您的机器上运行所需时间的详细分析。以下是 MiniProfiler 的输出示例:

[![](../Images/037f44930de6d16621ca8cd7457b6e4b.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--F4Hh9L6b--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.telerik.com/sfimages/default-source/blogs/2018/2018-11/MiniProfilerBasic.png)

MiniProfiler 还将分析来自实体框架的 SQL 查询——这使得查找长时间运行的查询变得容易。微型事件探查器还会标记重复的 SQL 查询。这里有一个例子:

[![](../Images/9fb13ab53d00e39be636d2f3da7c539c.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--ypzgxRbM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.telerik.com/sfimages/default-source/blogs/2018/2018-11/MiniprofilerSQL.png)

您还可以向 web 应用程序添加自定义的分析步骤。如果你有一个长时间的运行过程，你可以把它分成几个步骤，并跟踪每个步骤需要多长时间。在下面的代码中，我们向该方法添加了一个自定义分析步骤:

[![](../Images/bc113752aa0c0e6c364fd17c1622e1ec.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--G3CzWpQI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.telerik.com/sfimages/default-source/blogs/2018/2018-11/MiniprofilerCustom.png)

MiniProfiler 是一个很好的工具，可以在您使用它的时候测试应用程序的性能，但是它缺乏获取聚合性能数据的能力。为此，您可能需要一个应用程序性能监控(APM)工具。Application Insights 和 New Relic 很受欢迎，但还有很多选项。这些工具将测量您的 web 应用程序的整体性能，确定平均响应时间，并为您标记缓慢的响应。

一旦你准备好了测量工具，你就可以着手解决问题了。在修复性能问题时，开发人员应该在每次干预前后进行测量。此外，一次只改变一件事是明智的——如果你改变了几个因素并重新测试，你将不会知道那些干预措施中的哪一个(如果有的话)起作用了。提高应用程序性能就是运行不同的实验。测量性能会告诉你哪些实验有效。

另一个测量性能的便利工具是[Telerik Test Studio](https://www.telerik.com/teststudio)——一个受开发人员& QAs 喜欢的测试自动化解决方案。虽然主要目标是自动化 web/桌面/移动 UI 测试，但 Test Studio 在负载和性能测试方面也很有帮助。开发人员可以捕获 HTTP(S)流量并定制请求，以衡量对性能的影响，记录的 Test Studio web 测试可以重用于负载测试。底线是，开发人员应该使用所有可用的工具来测量速度，看看性能调优能有什么帮助。

## [](#performance-tips)性能提示

有许多性能调优技术——最好的是基于实际生产应用程序的。但是不能盲目地应用性能提示——开发者需要衡量干预措施，并确保它们对给定的应用程序有效。仅仅因为某些东西在一个应用程序中有效，并不意味着它对另一个应用程序也有好处。让我们快速浏览一下后端应用服务器的一些常见性能调优技术。

### [](#dealing-with-databases)处理数据库

数据对任何应用程序都至关重要，但数据库也可能是最常见的性能瓶颈。你的数据库查询需要高效。使用您最喜欢的分析器，找到运行缓慢的查询，并尝试直接对数据库运行它。如果将 SQL Server 用作数据库，开发人员还可以使用 SQL Server Management Studio 并检查执行计划。如果使用关系数据库，应该确保正在搜索的字段符合适当的索引——如果需要，可以添加任何必要的索引并重试。如果你的数据库查询很复杂，你可以试着简化它或者把它分成几部分。

如果优化 SQL 查询不是你的强项，有一个捷径。在 SQL Server Management studio 中，转至“工具”>“数据库优化引擎顾问”。通过这个工具运行你的查询，它会给你如何让它运行得更快的建议。

### [](#get-the-right-stuff)得到合适的东西

你的 web 应用程序在给定屏幕上显示的内容应该与你从数据层获取的内容有精确的关联——不应该抓取任何不必要的数据。开发人员需要警惕重用昂贵的项目检索来获取小网格相关对象的完整图形。

另一件要考虑的事情是，你的用户可能不会阅读你推送到客户端的 10，000 个项目——至少不会同时阅读。开发人员必须考虑批量获取数据，并使用分页来限制检索到的数据集的大小。像[剑道 UI](https://www.telerik.com/kendo-ui) 或 ASP.NET 的 Telerik UI[MVC](https://www.telerik.com/aspnet-mvc)/[Core](https://www.telerik.com/aspnet-core-ui)这样的网络应用的现代界面已经有了智能 UI 控件，可以通过分页与大块数据无缝协作——开发者不需要重新发明轮子。

### [](#cache-slow-calculations)缓存缓慢计算

更快获取数据的最佳方式是根本不获取数据。巧妙使用缓存可以从根本上提高 web 应用程序的性能。在 ASP.NET 核心中，数据缓存有两种风格——内存缓存和分布式缓存。

内存缓存将缓存的数据存储在服务器上。虽然这是最容易使用的缓存，但它也仅限于单个服务器。如果运行多台服务器，每台服务器都有不同的缓存。

分布式缓存使用数据存储来保存缓存的数据。您可以运行任意多的服务器，它们都将访问同一个数据缓存。分布式缓存最常见的两种数据存储是 SQL server 和 REDIS——这两种存储都很容易设置。

因为它非常有效，一些开发人员会想要缓存所有的东西——这可能会适得其反。缓存增加了应用程序的复杂性，性能提升并不总是值得的。开发人员应该将缓存限制在难以计算或变化缓慢的事物上。另一个技巧是尝试将所有数据缓存逻辑放在应用程序的一个层中——到处扔缓存命令会使跟踪潜在错误变得困难。

### [](#crush-it-with-response-compression)用响应压缩压碎它

在提高 web 应用程序的性能时，最大限度地减少网络上的数据量非常重要。对于那些从手机上使用你的网络应用的人来说尤其如此。减少发送位数的一种方法是启用响应压缩。默认情况下，ASP.NET 核心将 GZIP 几种不同类型的请求。但是，它不会 GZIP 常用的响应，包括 CSS、JavaScript 和 JSON。在 ASP.NET 核心之前，您必须编写定制的中间件来压缩这些类型的响应。在 ASP.NET 核心中，中间件是内置的...你需要做的就是把它添加到你的`Startup.cs`文件中，就像这样:

[![](../Images/d3d2539476b63f96e95eefeae4adb2e5.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--i724JMUv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.telerik.com/sfimages/default-source/blogs/2018/2018-11/ResponseCompression.png)

### [](#dont-create-a-logjam)别制造僵局

虽然大多数日志记录框架将其性能成本保持在最低水平，但日志记录仍然是有成本的。过多的日志记录会在高负载时降低应用程序的速度。在生产中，开发人员应该只记录支持监控和日常故障排除所必需的内容。您应该将详细日志记录保存在性能成本允许的较低环境中。此外，日志级别最好是可配置的——如果您需要临时打开日志来收集某个问题的数据，您应该能够做到这一点，而无需重新编译您的应用程序。

### [](#ace-your-async-requests)Ace 您的异步请求

使用 C# `Async/Await`进行异步编程是提高应用程序性能的一个很好的方法，但是你需要注意这些关键字不会并行运行命令。Await 停止执行您的代码——因此，如果您有多个正在等待的异步请求，您的单个性能将与您连续运行这些请求时一样。

然而，这并不意味着您不应该尽可能地异步。异步仍然可以提高应用程序的性能，但只是在负载情况下。通过减少等待的线程数量，async/await 增加了应用程序的吞吐量。

如果想提高个人性能，需要利用*任务并行库(TPL)* 。通过管理您自己的任务，您可以并行执行事情。如果您对一个方法有几个缓慢的调用，比如调用一个外部服务，您应该考虑并行运行它们，而不是使用 async/await。

以下示例说明了这两种方法。顶部的方法使用标准的 async/await 流，底部的方法使用任务对象。并行运行任务会使用更多的代码，但是并行运行几个缓慢的请求会节省时间。

[![](../Images/9492688796ffcb055a568a935e58d077.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--WFdWgFR0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.telerik.com/sfimages/default-source/blogs/2018/2018-11/ParallelvsAsync.png)

## [](#make-your-apps-faster-today)让您的应用更快

构建高性能的 web 应用程序是一项艰巨的工作，但是 ASP.NET 核心有很多工具和特性可以帮助你。开发人员应该从使用 MiniProfiler 和 Application Insights 等工具测量性能开始。然后，当你发现瓶颈时，检查一下清单，看看哪些干预措施对你的应用有帮助。性能调优需要耐心和实验——希望随着前端和后端流程的简化，您可以通过调整旋钮看到性能的提高。高性能的网络应用程序意味着愉悦的用户和更高的参与度——为此干杯。