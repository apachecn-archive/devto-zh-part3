# 社交登录，如何工作？

> 原文:# t0]https://dev . to/limawi/les-social log in-comment-ca-marche-15ol

## [](#comment-%C3%A7a-fonctionne-)怎么工作？

所有基础的基本协议是 oauth 2。所以我们就从他开始吧。

### [](#oauth2)Oauth2

如果有 2 个，就表示是第二个版本

第一个版本 oauth 存在许多安全漏洞。永远不要使用它。

oauth 2 是管理授权的协议。它允许设备访问服务器上的资源和数据。

为此，他使用性交。这些参数需要访问特定资源。

例如:*scope*profile 请求访问用户配置文件信息。

服务器返回一个“”声明。这是请求数据的表示。

因此，对于的范围，就有*的主张* :

```
{
  name: Alice le Lapin,
  firstname: Alice,
  lastname: le Lapin
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

该协议可以处理各种授权方法，但对于社会登录，我们只关心一种方法。

### [](#octroi-dun-code-dautorisation-authorization-code-grant)授予授权码(授权码授予)

此认证方法可让服务授权使用者登入，而不需要密码，而是信任授权伺服器。

操作如下:

*   用户要登录到服务
*   服务会将用户重定向到授权服务器访问页
*   如果用户尚未登录到授权服务器，则该用户将登录到授权服务器(此时，该用户将使用其密码-在授权服务器上)
*   授权服务器向用户显示“确认”面板，询问用户是否确实要登录到服务
*   用户确认
*   然后，服务器会使用授权代码将用户重定向到服务
*   服务使用收到的授权码请求授权服务器访问代码(“T0”令牌“”)
*   授权服务器接受用户的服务连接
*   用户已登录到服务

如您所见，用户从未在服务中输入过自己的密码。密码存储仅在授权服务器上执行。

## [](#openid-connect)OpenID 连接

oauth 2 扩展由 OpenID 基金会管理。该基金会还管理原有的 OpenID，它有自己的功能。

此扩展支持身份验证。它使用授权服务器作为验证服务器。

根据“T0”授权代码 grant 的工作方式，它使用服务器返回的信息(唯一标识符，通常是电子邮件，即使最好是 UUID)向服务器验证用户身份。

此外，此扩展具有以下选项:

*   验证伺服器提供的 UserInfo 存取点-动态撷取使用者设定档资讯：
*   验证伺服器提供的阶段作业存取点:可让您验证阶段作业，例如同步化阶段作业，以确保使用者在服务上的阶段作业与伺服器上的阶段作业同时结束。
*   断开用户与身份验证服务器的连接时，断开用户与所有服务的连接：
*   一种隐式连接流，名为*单点登录*，它允许用户透明地连接到服务。服务和服务器似乎都整合到一个应用程序中。在 [Limawi](https://limawi.io/fr-fr) 我们在内部为博客建立了这样的系统。

### [](#les-avantages)优势

该系统允许在不使用每个服务密码的情况下将服务链接在一起(从而提高安全性)。

此外，它还允许跨部门同步信息(数据)，因为它有一个参考信息存储库(存储信息的位置)。这样可以减少信息冲突，如果做得好的话。

### [](#les-risques)风险

使用此类系统需要信任授权提供者。用户可以访问与其相关的服务中的信息，因为用户可以伪装成用户并获取授权代码，而不是用户。

身份和对象(数据)的同步并不总是成功的，因为您在授权服务器上更改了电子邮件，所以您可能会在同一服务中拥有多个帐户。基于电子邮件的服务不再检索以前的帐户，而是创建一个新帐户。

通常不实施断开连接。由于大型社会登录提供程序具有持续会话功能，因此许多服务不实施断开连接检查。您可以在验证服务器关闭(用户已注销 Facebook、Google)的情况下打开服务(用户已登录)。

如果授权服务器遭到攻击、损坏和破坏，则所有相关服务都将受到损害。

### [](#les-attaques)攻击

#### [](#clickjacking-d%C3%A9tournement-de-clic)点击包装(点击偏差)

黑客可以创建恶意服务，将授权服务器加载到透明的 iframe 中。

简而言之，假设您的身份验证服务器是智能手机。

单击智能手机屏幕中间的按钮接受服务

在 clickjacking 中，黑客将一张透明的电子表格拖到您的智能手机屏幕上，当您单击该按钮时，您实际上单击了该电子表格，并且您在不知情的情况下接受了恶意服务对您数据的访问。

对于开发人员，请考虑在 javascript 中实现 X-Frame-Options 标题并将其限制为最大值(例如，“t0”same origin“”)和/或 framebusting。

#### [](#crosssite-request-forgery-falsification-de-requ%C3%AAte-entre-sites)跨站点请求伪造(伪造跨站点请求)

黑客可以让用户单击服务器授权按钮，该按钮将重定向到黑客的恶意服务，而不是客户想要的服务。恶意服务检索授权代码并将用户重定向到正确的服务。

用户未看到任何内容，但恶意服务具有授权令牌，因此具有访问令牌。

对于开发人员，强制服务使用预先确定的重定向 url。

还有其他 CSRF(抑制攻击)的可能性，我将在以后的文章中更详细地介绍。

#### [](#confused-deputy-problem-probl%C3%A8me-du-d%C3%A9l%C3%A9gu%C3%A9-confus)困惑的副手问题(problème du délégué confus)

如果服务无法正确验证使用授权服务器的用户的身份，则会出现此问题。

恶意用户可以登录到授权服务器，并通过操纵服务用于标识用户的信息使服务认为它是另一个用户。

如果服务没有正确识别用户的可靠信息，则会被误导并打开对错误帐户的访问。

例如:

服务使用提供 UUID 和名称的授权服务器。

授权服务器有两个帐户:

*   爱丽丝·艾维克·UUID:46d 07175-DBF 2-46e 2-80fc-c 6493 e 481479
*   奥斯卡 avec UUID:362 b862 b-51 B3-41 F4-82c 7-82eb 677 a9 aa 4

授权服务器提供 UUID 作为唯一标识符，并期望服务使用 uuid。

但是，服务选择使用名称作为唯一标识符。

因此，Oscar 更改了 Alice 的名称(服务器允许这样做，因为唯一标识符是 UUID)。

现在，当 Oscar 登录到服务时，它将直接访问 Alice 的帐户(因为服务的唯一 id 是名称)。

对于开发人员，请确保选择唯一的标识符。UUID 是用于此目的的。uuid 不传输用户信息，因此不会阻止用户更改所有想要的信息(甚至是电子邮件)。