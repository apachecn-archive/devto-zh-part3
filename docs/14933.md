# 如何构建一个基础设施来轻松部署容器

> 原文:[https://dev . to/Chen/how-to-make-a-infra structure-to-easy-deploy-containers-gb2](https://dev.to/chen/how-to-make-an-infrastructure-to-easily-deploy-containers-gb2)

你很可能听说过容器。它们现在非常受欢迎，为了改变，它附带了很棒的文档。有很好的文章和教程涵盖了基础知识，什么是容器及其组件(图像、容器、Dockerfile 等)。还有一步一步的教程可以帮助你开始使用 Docker。
当我思考如何使用它时，我寻找一个*工作流程*。我挠了挠头，心想:

如何在容器中自动构建和部署(几乎)任何应用程序？

在这篇文章中，我将谈论我为自己的用例设计的*工作流*。
自动化，易于修改、重建和部署在新的或现有的容器实例上。
我的任务是将一个在 DockerHub 上没有图像的第三方应用程序进行 dockerize，而不是一个普通的应用程序。这是我第一次尝试 Docker。

我假设你熟悉 Docker 文件、图像和容器的 Docker 概念(如果不熟悉，这是一个开始的[好地方)和 Ansible。](https://docs.docker.com/get-started/#docker-concepts)

[![Photo by Dwinanda Nurhanif Mujito on Unsplash](../Images/96fc9ff8620585953b81c61adf45599c.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--DNI3n-Td--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/kcputn521ye04y2ire23.png)

*   [任务](#the-task)
*   [流量](#the-flow)
*   [展开](#deploy)
*   [自动化](#the-automation)
    *   [建造者](#the-builder)
    *   [部署流程](#deploy-process)
*   [结论](#conclusions)

## [](#the-task)任务

我的任务是部署一个第三方应用程序来监控我们的生产网络。是一个小型的*分布式* app，主从配合使用。我不会详细介绍这个应用程序(因为这超出了本文的范围)。
这是我做的第一个 docker 项目，所以我也必须开发基础设施。

我所说的为 Docker 开发基础设施是什么意思？

我需要首先定义流程，然后抽象它，这样我就可以尽可能多地重用它。这将允许我更快地添加新的 dockerized 应用程序，用最少的额外代码构建和部署它们，更重要的是，没有重复的代码。现在是定义这个过程的好时机，因为这是我的第一个 Docker 项目。

## [](#the-flow)水流

这里有一个决定，它定义了我想要实现的过程。正如我在引言中所说的，我不打算在这篇文章中讨论基础知识。然而，我将描述和解释这个过程中的每个组成部分，其中一些被认为是基本的。

[![build, push, pull, deploy.](../Images/01452b895003ffc12b2545d982f362fa.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--pfrqBBqs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6xpc9lwxcpkf3as9e1vi.jpeg)

*   docker file:*“docker file 是一个文本文档，它包含用户可以在命令行上调用的所有命令，以组合一个图像。”*一旦我们定义了 docker 文件，我们就使用 *docker* 命令行来*构建*它。执行的输出是一个*图像*。

*   **映像** : *“映像是一个可执行的包，它包含了运行应用程序所需的一切——代码、运行时、库、环境变量和配置文件。”*它是您可以从中实例化实例(容器)的蓝图。一个很好的类比是 OOP——你创建一个类，允许你创建对象(实例)。

*   **构建服务器**:执行 Dockerfiles 构建过程的集中式服务器，组成*镜像*。

*   **推送**:一旦我们有了一个图像，*将它推送*到注册表中，就可以在其他机器上下载了。可以把它想象成应用程序的 Linux 存储库，只是用于 docker 映像。

*   **注册表** : *“注册表是一个无状态的、高度可伸缩的服务器端应用程序，它存储并允许您分发 Docker 映像。”在我的例子中，它驻留在与构建服务器不同的机器上。但也可以是同一个。它只是一个在容器内运行的应用程序:)*

*   **拉**:你在你想要运行*容器*的机器上拉*图像*。如果您使用私有注册表，您需要将这些客户端连接到它。

*   **容器** : *“容器是一个映像的运行时实例——映像在执行时在内存中变成什么样子(也就是说，一个有状态的映像，或者一个用户进程)。”*

有关以上概念的更多信息，请查看 [Docker 入门](https://docs.docker.com/get-started/)链接。

## [](#deploy)部署

一旦我们有了本地可用的映像，我们就可以*运行*它的一个实例。

语法是:`docker run [ OPTS ] <IMAGE:TAG> [ CONTAINER_NAME ]`。有很多有用的选项，比如*卷*和*端口映射*。

在我描述自动化基础设施和过程之前，*使用容器有什么好处？*
以下是我为自己写下的**优点**:

1.  Docker 可以在任何安装了 Docker 引擎的平台上运行。我不关心依赖和启动脚本。我完全消除了这种担心。
2.  一个应用程序的部署通常与另一个应用程序相似。一旦我有了部署容器的基础设施，我支持另一个应用程序的时间就会缩短。
3.  启动容器的速度比虚拟机更快，并且消耗的资源更少。
4.  它提供了更有效利用硬件的灵活性。
5.  将应用程序升级到新版本会更快。
6.  您可以毫不费力地回滚。有东西坏了吗？只需从以前的映像重新部署即可。

***所提观点均来自 Ops 观点。*** *使用容器开发 App 有更多的优点(和缺点)。*

## [](#the-automation)自动化

[![](../Images/c4d35ceaecc17e123c718d910fcf7547.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--NAfBqJVC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/onbewl6iaum68piaebp3.png)

为了创建一个自动化的过程，我们需要这样定义。让我们定义构建和部署新映像的具体流程。

### [](#the-builder)建造者

构建器的角色是隐含的，即*构建*图像。虽然 docker 映像可以在任何地方构建(例如在开发机器上)，但我发现在构建服务器上做更好。*为什么？*

*   我喜欢有*单入口点*。我设置了一次环境，定义了工作要求，标准化了图像的命名和标记。我所有的图片都遵循相同的流程，不管是谁制作的。
*   如果由于某种原因我需要改变我的构建过程，我需要在一个地方更新它。
*   我有一个自动标记图像的脚本，从构建它的开发人员那里删除了这个任务。

詹金斯非常适合这项任务。

我创建了一个新的作业，它简单地构建 Dockerfile 并自动标记它们。我通过使用一个 *Makefile* 来构建图像并将其推送到我们的注册表中。

为什么我要使用 Makefile？嗯，我做了一个抽象的 Makefile。这允许我构建**任何**docker 文件。我为它提供了图片的名称和标签。然后，它在一个单独的过程中构建、标记和推送新图像到我们的注册表。

### [](#deploy-process)部署流程

这一节定义了如何在实例上提取图像和运行容器。

我们使用 Ansible 来管理我们的基础设施。它有一个很棒的 Docker 模块。我敢肯定，任何 IaaC 都有 Docker 模块，让您的生活更轻松。新映像的部署只需一项任务，它会处理好一切——提取新映像、启动新容器并提供特定的容器选项。

我创建了一个新的可负责的角色，准备好 *Docker 主机*。它生成目录并复制相关文件。该角色的职责是让主机准备好运行容器实例。注意*根据我们想要部署的应用程序，这里的步骤可能会有所不同。*

因为我让 Ansible 来管理配置，让 Docker 来实际运行应用程序，所以我有一个简短的 Ansible 剧本，它很干净并且非常容易管理。在此之前，我习惯于定义更大的剧本来准备一切和部署应用程序。

使用我的新剧本，我可以在几秒钟内用 docker 引擎在任何机器上实例化一个容器。Ansible 和 Docker 将完成这项工作。

## [](#conclusions)结论

这就是我最终得到的*工作流程*。我认为，现在我有了合适的工具和基础设施，对新的应用程序进行分类是简单而方便的。
在此之前，我已经使用了可行的剧本和角色来开发和部署新的应用程序。大部分时间它都像预期的那样工作，但有时也会出问题。一般要看平台。在 Ubuntu 14 上有效的东西，在 Ubuntu 18 上不一定有效。有时会缺少驱动程序或软件包依赖性。或者是别的什么东西。
这些陷阱不会发生在容器中，因为*应用程序需要的一切都在容器中。*

要部署新的应用程序，我的步骤如下:

1.  我需要定义一个 Dockerfile 文件
2.  验证它是否有效
3.  一旦我有了一个现成的映像——使用 Jenkins 来构建一个官方的映像并推送到注册表
4.  我为 Ansible 制定了部署流程的蓝图——我更新了相关的参数和任务，以便在容器中运行新的映像
5.  在我想要运行容器的新主机上运行 ansible playbook

如果你还没有尝试过使用容器，我真的**鼓励**你花时间学习这项技术。他们很棒。这是你工具箱中的一个很好的工具，并且很容易试用。

一些很好的资源是这个[博客文章](https://medium.freecodecamp.org/a-beginner-friendly-introduction-to-containers-vms-and-docker-79a9e3e119b)，和这个[教程](https://docker-curriculum.com/)。试着玩玩吧。

你有不同的工作流程吗？随意分享。

另外，这是我发表的第一篇博文。任何反馈都将不胜感激。