# 部署与发布

> 原文:[https://dev.to/zygo-tecnologia/deploy-vs-release-17eo](https://dev.to/zygo-tecnologia/deploy-vs-release-17eo)

[![](../Images/e5e0b7724b7eea53bf899391886d16c7.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--D2-vVXs5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/460/1%2AXinvqThF8j0ImXTytHV7_Q.jpeg)

我先从上面的图片开始，上面清楚地描述了我们在 Zygo 的部署流程，下面我想告诉大家我们如何将 deploy 与发行版分开，从而大大减少对客户的影响。

去年(2018 年)中期，我在读《加速的‘t1’一书，这是关于‘T2’、‘Nicole forsgen’、‘T4’、‘卑微的 jez’、‘t5’和‘T6’Kim’基因‘T7’进行的 4 年期研究，以了解前项内容

该书以研究为背景来定义导致公司在软件交付方面表现高、中或低的行为，其使用的衡量标准之一是部署频率，根据研究数据得出的结论是，表现最好的公司是越来越多地为每个开发人员部署的公司也就是说，如果团队有 5 个开发人员，每周部署 5 个，10 个开发人员每周部署 10 个以上，如果以前每个开发人员部署一个，则这将成为一个以上的关系。

尽管这一结论常常看起来很明显，因为如果目标是交付软件，那么我们做的部署越多，我们将交付的软件就越多，对吧？但这并不总是明确的，而且在许多企业中部署也有不好的一面，比如在生产过程中遇到错误等。

好吧，做了这么多介绍之后，让我们到我想说的地方。读这本书时，作为 [Zygo](https://site.zygotecnologia.com/home/) 工程领域的负责人，我已经对我们的部署过程感到不安，但缺少数据，更确定的是如何解决，而借助这本书的研究数据，我确信我们已经走上了被他们评价的低性能企业的道路。我们当时所做的是利用开发、暂存和 master 这三个独立的分支进行开发，生产部署必须与公司的其他部门一起进行规划和组织，以免让人感到意外，每次我们不得不通过开发代码时都会发生混乱

我知道我们迫切需要改变这一点，但我必须决定从哪里开始。第一步是思考是什么让我们走到了今天的地步，我们来到这个过程有两个原因:

*   **以往部署时遇到很多错误的不良经验**:中断 3 支开发，想到提前 1 周将暂存分支置于测试环境中，让公司在投入生产前进行测试和发现错误，就是为了努力提高这一点
*   **与 CS 和销售团队缺乏协调一致:** CS 和销售人员在与客户/销售线索通话的中间时，由于部署会更改某些功能，因此不知道如何使用更改后的功能，最终产生了 insert

经过深思熟虑，再到了原因，更清楚的是，我们因为他们而实施的过程没有奏效，因为它没有帮助解决我刚才提到的两个问题中的任何一个。

再一次思考这两个问题，我得出结论，这实际上是因为我们的版本与 deploy 紧密相关，也就是说，将新代码投入生产也意味着同时向客户提供更改或新功能。哎呀，我们终于到了根本问题，找到了在过程中真正需要改变的东西。

随着问题的定义，我们一直在寻找解决方案，最大的挑战是改变团队开发人员的开发过程。无论您是谁或以前是开发人员，您都知道，请求更改功能时的正常流程是开发人员首先删除或更改代码，但是如果我们希望能够部署更改和新内容，而不希望在部署时向客户显示这些更改和新内容，则需要保留旧代码和新代码 它需要从开发一开始就考虑如何维护当前代码并添加新代码，而不会导致当前运行中出现任何错误。 为此，我们选择了功能切换工具，在我们的例子中，我们选择了 gem [flipper](https://github.com/jnunemaker/flipper) ，并开始在开发团队中创建文化和 mindset，从而使之成为可能。

经过几个月的努力，我们终于取得了成果，其中最大的优势是:

*   通过选择我们希望谁测试新闻，让我们能够在发布到整个数据库之前收集更多信息，让我们能够验证生产中的假设和想法。
*   发现错误和可用性问题时，只有少数客户在使用该新功能，其影响远低于向所有客户发布后发现的影响；
*   我们减少了与公司其他部门的发行摩擦，有时间为客户和公司本身制作有关新内容的教材；
*   尽管有这些优势，但我们仍然能够在不到 2 周的时间(有时不到 1 周)内将所有版本提供给 100%的客户。
*   master 代码始终是最新的，随时可以投入生产，而无需担心部署会对客户造成什么影响；
*   开发团队的部署数量有所增加，但现在公司的其馀部分却对此视而不见，因为影响他们和我们客户的只有发行版。

那么，这么说吧，这似乎是银弹对于任何开发团队来说能够更好、更容易和更敏捷地交付，但一切都有它的代价和坏处。通过使用 toggle 函数，代码开始具有 ifs 和条件，并检查每个更改和/或新内容是否可能显示给谁。从长远来看，这是一项技术上的负担，会使代码更难维护、更正和改进，因此，以这种方式工作非常重要，因为您需要创建一个例行程序，即在发布完成并 100%可用后，团队将返回代码以清除为启用该功能而设置的 ifs 和条件

对于那些对我引用的书感兴趣的人来说，[在这篇帖子](https://medium.com/slashdeploy/book-review-accelerate-92ebc00f4354)有一篇很好的评论，更多地谈到了这本书。

下面是有关 toggle 功能实践的一些链接，您可能还想了解更多有关它的信息:

*   [https://martinfowler.com/articles/feature-toggles.html](https://martinfowler.com/articles/feature-toggles.html)
*   [https://www . infoq . com/br/presentations/feature-toggles-OS-2-lados-do-poder](https://www.infoq.com/br/presentations/feature-toggles-os-2-lados-do-poder)
*   [http://featureflags.io/](http://featureflags.io/)
*   [https://stack overflow . com/questions/7707383/what-a-feature-flag](https://stackoverflow.com/questions/7707383/what-is-a-feature-flag)
*   [https://medium . com/jet tech/feature-toggles-give-you-super power-78 fdeb 7 ab 5 e 8](https://medium.com/jettech/feature-toggles-give-you-superpowers-78fdeb7ab5e8)

* * *