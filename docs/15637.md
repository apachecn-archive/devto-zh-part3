# 调试技巧和故事

> 原文:[https://dev.to/markerikson/debugging-tips-and-tales-3n5i](https://dev.to/markerikson/debugging-tips-and-tales-3n5i)

*最初[发布在我的博客](https://blog.isquaredsoftware.com/2019/01/blogged-answers-debugging-tips/)上[https://blog.isquaredsoftware.com](https://blog.isquaredsoftware.com)T5】*

上周的[# dev discuse](https://twitter.com/hashtag/devdiscuss)讨论是关于[调试](https://twitter.com/ThePracticalDev/status/1085357114464370688)的话题。这是我有很多意见和建议的事情，[所以我回复了一个我的建议的快速列表，以便更好地调试](https://twitter.com/acemarke/status/1085357989391945728)。同样值得以博客的形式记录下来。

> 本·麦考密克给我看了他几年前写的一篇非常相似的文章。非常优秀，你也应该看看:[调试工具箱](https://benmccormick.org/2014/08/19/the-debugging-toolbox)

## [](#marks-debugging-advice)标注的调试建议

### [](#1-reproduce-the-issue)1)再现问题

重现问题是关键。如果不能重现问题，就很难弄清楚发生了什么并迭代修复。更重要的是，如果你不能再现，你很可能不能证明一个“修复”实际上是有效的。

### [](#2-errors-provide-useful-information)2)错误提供有用的信息

错误消息和堆栈跟踪非常重要。去年，@swyx 在一篇关于这个话题的开发帖子中引用了我的话:[如何谷歌你的错误](https://dev.to/swyx/how-to-google-your-errors-2l6o)。他们通常会给你一个很好的起点，让你知道问题在哪里，为什么会发生。阅读信息。如果需要的话，谷歌一下。

### [](#3-learn-to-use-debuggers)3)学会使用调试器

了解你的工具。无论您使用什么 IDE / DevTools，大多数调试器的工作方式都是一样的。理解断点、监视、单步执行。使用条件断点或“观察点”等更高级的功能来记录消息，而不是停止。

### [](#4-print-logging-is-important)4)打印日志记录很重要

有时 IDE 调试器不能解决这个问题，尤其是在远程系统或多线程环境中。良好的控制台/打印机调试仍然很重要。这有助于通过配置文件启用大量不同级别的现有日志记录。

### [](#5-debug-with-a-plan)5)有计划地调试

提出一个假设。先理解代码*应该如何表现*。看实际行为。你或许可以做出有根据的猜测，判断事情的发展方向。专注于这些领域。不要乱拧。一次改变*一件*事情，然后比较结果。据此缩小可能的原因。

### [](#6-dont-be-afraid)6)不要害怕

经验是有帮助的，但是如果你是新手，不要害怕投入进去，因为这是你获得经验的途径:)即使一个问题看起来真的很复杂，也要花一些时间把它分解成更小的部分。戴夫·塞德迪亚和[戈萨·阿里尼克](https://goshakkk.name/no-tutorial-for-everything/)都从构建新项目和学习新主题的角度，就分解问题的主题写了很好的建议，但同样的概念也适用于调试。

### 7)知道什么时候该坚持，什么时候该停止

坚持是好的，在一个问题上建立心理背景需要时间，但有时你需要休息一下。很多次，我离开工作，回家，放松，并在一夜之间或早上找出问题所在。

关于这一点，我将重述几个我最好的调试故事。

## [](#tales-of-debugging)调试的故事

### [](#the-case-of-the-wrong-case)错案的情况

几年前。我有一个正在处理大量数字运算的 Python 服务，所以我使用 [Cython](https://cython.org/) 来加速代码中数学密集型的部分。Cython 是一个工具，可以将普通的 Python 代码编译成 C，这样运行起来就更快了。如果添加额外的类型声明，它可以生成更高效的 C 代码，因为它知道每个变量的类型是什么。

Cython 有几种方法可以声明类型。您可以将您的`.py`文件重命名为`.pyx`，并直接在代码中添加类型；您可以使用 decorators 来声明类型；或者你可以添加单独的声明类型的`.pxd`文件。我使用并排文件的方法来设置它，这种方法允许您保留原始的 Python 文件。为此，`.pxd`文件的类型必须与原始的`.py`文件的名称完全匹配。所以，如果我有`FileA.py`，我也会有`FileA.pxd`。

我为 Python 函数和变量添加了类型定义，并引用了几个来自`<math.h>`的 C 数学函数。这项服务主要在 Linux 上运行，但是我的大部分开发工作是在 Windows 上进行的。我在我的本地 Windows 机器上做了最初的修改，测试了代码，它看起来工作得很好。

不幸的是，当我在 Linux 上运行它时，它编译得很好，但是开始抛出一些隐藏在代码深处的奇怪异常。实际上，我自己并没有编写这个服务的数学部分，所以我不熟悉实际的逻辑。我将问题一直追溯到代码中，最终得出结论，某个特定的函数试图调用`cos()`三角函数，但是调用失败了，因为`cos`似乎不存在。这没有任何意义，因为如果使用 Cython，我是从`<math.h>`显式导入 C 版本的`cos`，否则从`math`模块导入普通的 Python 函数。

我花了大约 6 个小时的跟踪、调查和不断增加的困惑，才最终弄清楚发生了什么:在一个`.py`文件和它对应的`.pxd`文件之间有一个字母大小写不匹配。一个是大写的 O，另一个是小写的 O。这在 Windows 上运行良好，因为 Windows 文件系统是不区分大小写的(所以`filea.txt`被认为与`FileA.txt`相同)。但是，Linux 文件系统是区分大小写的，所以文件可以用不同的字母大小写来命名。正因为如此，Cython 编译器实际上从未找到与原始`.py`文件匹配的`.pxd`文件，没有得到正确的导入，因此东西最终爆炸了。解决的办法是把大写的“O”改成小写的“O ”,并且成功了。

绝对是一个相当高的工作时间与字符数变化的比率:)

### [](#a-twisted-tale)一个扭曲的故事

最近，我们收到报告称，我们的一个 Python 服务似乎完全锁定了。这个特定的服务充当反向代理，将 HTTP 请求转发给系统的其余部分，并处理身份验证请求。

主要症状是我们的应用程序都无法在浏览器中加载。奇怪的是，日志中没有明显的错误，但那是因为服务*的日志在症状出现时完全停止了*。

这个 Python 服务建立在扭曲的网络框架之上。Twisted 使用一个[“事件循环”](https://stackoverflow.com/a/35119594/62937)，类似于 Javascript 和 Node.js 的工作方式。它有一个事件队列，对于每个事件，运行相关的代码直到完成。如果您有大量 IO 发生在后台，这是非常好的。但是，这也意味着如果一个特定的脚本需要很长时间才能运行，它可能会阻塞整个事件循环并阻止任何其他代码运行。

我被这个问题难住了一段时间，但我有几个猜测。我的假设是，该服务发出的一个外部调用从未得到响应，因此阻止了事件循环的继续。

我们调高了该服务的日志级别，重新启动，然后等待它再次发生。当它发生时，我看了看日志。果然，服务试图做的最后一件事是向 LDAP 服务器发出外部请求，以查询一些用户数据。

我做了一些测试，并确认所有的外部请求都发生在主线程上，与事件循环相同(我通过修改日志配置来打印日志语句发生的线程的名称)。相反，我将所有这些外部请求转移到后台线程中，并修复了调用的超时设置，使它们不会无限期地阻塞。

这些更改解决了该问题。我们后来发现，这些问题实际上与 LDAP 服务器经历 100% CPU 使用率的时间相对应，从而确认了外部原因。

这个故事的寓意是，了解底层技术的行为方式让我能够对问题的可能原因做出有根据的猜测。

## [](#final-thoughts)最后的想法

调试是收集信息、解决问题和知道如何使用可用工具的结合。文章和课程可以教会你很多东西，但是调试是我觉得真正需要实践和经验的东西。

所以，下一次当你看到你的应用程序在日志中抛出错误，或者只是“不工作”的时候，不要惊慌！ 你可以这么算:)