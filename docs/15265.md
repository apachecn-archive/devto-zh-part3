# 小心 JWT 炒作列车

> 原文:[https://dev . to/darraghor/小心 jwt-hype-train-3e81](https://dev.to/darraghor/be-careful-of-the-jwt-hype-train-3e81)

几个月来，我一直在研究使用 node 作为后端，GitHub 上的许多 node 文章、课程和项目“初学者”都建议在面向 API 的客户端上使用 JWT 作为会话令牌。

我认为有太多的炒作，人们使用 JWT 是因为它有光泽！

## [](#what-is-jwt)🔐什么是 JWT？🔐

JWT 是一个以标准化方式签名的 JSON 对象。然后，可以通过任何机制将该签名的对象或令牌发送给用户。它通常在 HTTP 响应的正文中或者在 cookie 之类的头中返回。客户端将其发送回您的服务器，在那里您检查签名并使用提供的数据，如果它是有效的令牌。

其思想是，token 存储了关于用户及其对 API 上的资源的权限的所有细节。当用户发送一个有效的 JWT 请求某个资源时，您的 API 不必命中另一个资源来获取数据。

这与发送到客户端的简单会话 ID(通常在 cookie 中)形成对比。客户端会在每个后续请求中将其发送回您的服务器。服务器根据保存在数据库中的列表来验证会话 ID。然后，它查找任何需要的关于用户的信息来完成请求。所有状态都保留在服务器/数据库上。

对于 web 应用程序上的客户端会话，JWT 是一个糟糕的解决方案。

## [](#it-will-make-my-api-stateless)“这会让我的 API 无状态”

这时，您计划将所有用户数据和权限等放在令牌中，这样您就不必调用数据库来获取 API 上的用户数据。听起来不错，但是...

### [](#its-probably-premature-optimisation)这可能是过早的优化

如果您正在构建一个客户端服务器 web 应用程序，并且您期望每分钟对数据库的请求少于 4000 个，那么最低支付层(每月 50 美元)的 Postgres 和 Heroku 上的廉价 dyno 可以为您处理这些问题。你不需要任何无状态的东西，甚至不需要 memcached 或 Redis。

即使是完全免费的 Heroku 层也应该可以每分钟处理至少 120 个请求。如果你的项目如此受欢迎，你应该升级(祝贺成功！).

除非你期望显著的规模，否则对于几乎任何公司的产品，你都可以扩大数据库会话，直到你有足够的现金和工程人才来添加其他东西。不要过早优化。

### [](#is-your-api-truly-stateless-for-user-data)你的 API 真的是用户数据无状态吗？

在一个有用的客户端到服务器的 web 应用程序中，很难避免状态。在每次请求时，您真的没有从数据库中检索到关于您的用户的任何其他信息吗？自 JWT 发布以来，可能没有发生任何角色变化或支付状态变化？用户和特定请求之间完全没有交集吗？

就像如果你有一个微服务架构或什么的话，这是可能的，但一般来说不太可能。

### [](#you-cant-implement-stateless-basic-account-administration)不能实现无状态基本账户管理

许多文章将向您展示如何设置和登录 JWT，但他们忽略了困难的部分-注销用户和黑名单用户。这些功能可接受的解决方案包括维护状态。

如果您想合法地让用户“注销”,那么您需要保存一个被用户无效的 jwt 的列表。现在，每个请求都要检查状态。

如果您使用 salt 对每个用户的令牌进行签名，以便以后可以更改 salt 来注销用户，那么您必须在用户每次发出请求时检查 salt 列表，现在您已经检查了每个请求的状态。

如果您希望能够阻止一个用户，因为他们的帐户是在债务中，被删除，或他们不怀好意，那么现在您需要保持一个被阻止的用户列表，并且您有状态检查每个请求。

如果您增加 JWT 的瞬时性来支持注销，那么每 5 分钟就会有一个用户登录，这是一个糟糕的用户体验，并且可能没有用户。

## [](#stateful-jwt-i-just-store-the-user-id-in-my-jwt)有状态 JWT——“我只是将用户 Id 存储在我的 JWT 中”

是的，你可以把一个用户标识符编码成一个 JWT 放在一个 cookie 中，像一个会话 cookie 一样使用它，但是这是与 JWT 的服务器会话。为什么要和 JWT 争论呢？只要使用会话库中的某种 uuid 就可以了。

## [](#jwt-is-supported-in-all-these-frameworks-and-works-better-across-both-browsers-and-mobile-clients)“所有这些框架都支持 JWT，它在浏览器和移动客户端上都能更好地工作”

饼干也是。Cookies 只是一个 HTTP 头。任何 HTTP 客户端都可以读取和设置头。cookies 头还内置了 20 多年的安全性和浏览器功能(仅限 HTTPS、过期、站点范围、阻止 JavaScript 访问),并且有一些众所周知的问题修复程序，如伪造 CSRF 令牌。

每个后端 web 框架都支持 HTTP 头，事实上可能对 cookies 有一流的支持，有一个会话库(通过一个生成的 id)绑定到某种数据存储。

## “JWT 是安全的”

签名和验证非常安全。然而，许多文章和课程描述了在本地存储中存储您的 JWT。这不安全。页面上的任何 JavaScript 都可以读取并使用它。

几乎可以肯定的是，页面上的 JavaScript 不是你写的，而是来自 NPM 的软件包或 CDN。这种方式的漏洞注入以前已经做过，以后还会发生。

本地存储的替代方法是将 JWT 存储在 cookie 中。因此，现在您需要保护 cookie，就像使用旧的学校会话 Id 一样。

## [](#so-what-should-you-do)那么应该怎么做呢？

你可能不需要 JWT。JWT 有它的用途，但很有可能它实际上不是您的应用程序的正确解决方案，它使事情变得比使用 id 和 cookies 的会话存储更加复杂或不安全。

所以，在将它添加到你的新应用程序之前，请确保你知道你为什么使用 JWT，并理解它的局限性！！😊