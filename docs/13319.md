# 当我关闭整个组织的构建管道时

> 原文:[https://dev . to/ankitvijay/when-I-down-build-pipeline-for-entire-organization-57kh](https://dev.to/ankitvijay/when-i-brought-down-build-pipeline-for-entire-organization-57kh)

去年 12 月，也就是上周，在大多数 IT 员工享受他们应得的假期之前，当每个团队都试图在代码冻结之前做最后一次部署时，我几乎停止了公司每个项目的构建管道。听起来很恐怖？事情是这样的。

## [](#how-it-all-started)这一切是如何开始的

我们主要是一个. NET 商店，并使用团队城市为我们的建设。我们有许多构建代理来运行 Team City 项目的构建。事件发生前几天，我们更改了项目的存储库名称。随后，我们为我们的项目更新了 Team City 中的回购路径。之后，我们对构建进行了一次试运行，并确认它是绿色的。

## [](#what-caused-the-issue)什么导致了这个问题

然而，一旦进行了这些更改，我注意到我们的一些特性分支构建，只有在某些构建代理上开始失败，并出现一个奇怪的错误*找不到主分支..某事某事*

我读了一些关于这个问题的资料，这似乎是一个缓存问题，Team City 由于某种原因无法获取更新的存储库路径名。清除相关的 Team City 缓存变量看起来很合理。所以，我清除了一些缓存变量。在那之后，我在所有代理上运行了我的构建，一切又恢复了正常。

## [](#the-chaos)混乱

第二天，当我到达办公室时，有一个 choas。人们抱怨团队城市建设的失败。因为我是最后一个接触团队城市配置的人，所以很可能是我的改变导致的。

我们开始深入研究这个问题。我们发现团队城市的“Nuget 插件”工作不正常，几乎所有的版本都出现了一些奇怪的错误。所以，我们做的第一件事是每个 IT 专家都会做的，尝试**重启构建服务器和构建代理**:)。不幸的是，这一次没有帮助。网上完全没有帮助。

## [](#the-fix)修罗

经过几次尝试和错误，我们终于设法解决了 NuGet 插件的主要问题。

清除缓存已经卸载了所有 NuGet 版本和构建代理的 NuGet 插件。要解决这个问题，我们必须手动停止构建代理，重新安装 NuGet 版本并再次启动构建代理。然后，对所有需要的 NuGet 版本重复这个过程(每个项目使用不同的版本——可能是构建创建时的最新版本)。更让我们痛苦的是，Team City Nuget 插件是区分大小写的，出于某种神秘的原因，其中一个 Nuget 版本文件的大小写与 Team City 所希望的不同。幸运的是，我们能够解决所有与 Nuget 插件相关的问题。

修复 NuGet 插件问题修复了我们大多数项目的构建管道。但是，很少有人仍然失败，因为他们依赖于构建服务器上缓存的 NuGet 包。要解决这个问题，我们必须在构建步骤中添加相关的 NuGet 源提要。

## 事情还没有结束。

就在我认为所有的问题都解决了，我可以平静地回家的时候，生活又回到了原点，我们开始得到我构建的原始错误。在这个时间点上，我不可能冒同样的风险去清除团队城市缓存。

所以，我做了进一步的调查，发现了这个问题。以下是该问题的摘要:

我们使用 [GitVersion](https://gitversion.readthedocs.io/en/latest/) 进行[语义](https://semver.org/)版本控制。 **GitVersion** 需要访问主/开发分支来计算版本号，但是 Team City 默认情况下不**获取**主分支(除非已经获取)。为了解决这个问题，我所要做的就是添加一个配置参数**numbers . git . fetchallheads = true。**添加此参数修复了该问题。

## [](#lessons-learnt)吸取的教训

我们从这次事件中吸取了很多教训。首先，在处理 Team City cache 时要小心。然而，这里有一点很关键，那就是所有不依赖团队城市插件的版本(像我的)都没有任何问题。作为一个组织，我们更倾向于*编写*构建步骤，而不是使用插件。这件事正好验证了我们的决定。尽管曼城队提供了很多好东西，但我觉得它还有很长的路要走。虽然其他构建管理工具支持 YAML，但是通过 UI 配置构建仍然是 Team City 的首选方式。您不能对您的生成定义进行版本控制。也许作为一个组织，我们需要开始评估市场上的其他选择。

## [](#final-thoughts)最后的想法

这件事让我意识到我们的 IT 团队有多牛逼。没有相互指责，每个人都专注于解决问题。我很幸运能在这里工作。我们正在扩张，所以如果你有兴趣加入我们的团队，请给我发电子邮件到[vijayankit@outlook.com](mailto:vijayankit@outlook.com):)([https://s.w.org/images/core/emoji/11/72x72/1f642.png](https://s.w.org/images/core/emoji/11/72x72/1f642.png)

当我为整个组织打下构建管道的帖子[首先出现在](https://ankitvijay.net/2019/02/15/when-i-brought-down-build-pipeline-for-entire-organization/)[嗨，我是 Ankit](https://ankitvijay.net) 。