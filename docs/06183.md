# DEV 注意:不要忘记清除缓存！

> 原文:[https://dev . to/Jess/dev-notes-don-t-forget-to-clear-cache-962](https://dev.to/jess/dev-notes-don-t-forget-to-clear-cache-962)

这篇文章是写给任何想为开发代码库做贡献的人的，并且需要一些关于缓存如何影响他们正在工作的特性/bug 的注释。

在[我们的文档](https://docs.dev.to)中，我们没有太多关于缓存的信息，除了 fastly 被列为我们依赖的边缘缓存的关键服务。从理论上讲，这个小说明为有经验的 rails 开发人员提供了足够的信息，让他们知道要考虑什么以及如何在开发中导航缓存，但是很可能会让初级人员完全不知所措。

如果你像我一样是一名训练营的毕业生，缓存可能根本不会出现在你的课程中——这是因为在你的应用程序提供大量流量之前，缓存并不是你真正需要考虑的事情。因此，如果您不熟悉缓存的一般概念，请先阅读凯文·科诺年科的这篇精彩文章:

[![kbk0125](../Images/adf31106495387012f2bda8711ca7d7b.png)](/kbk0125) [## 用在超市买牛奶来解释 Web 缓存

### 凯文·科诺年科 6 月 26 日 187 分钟阅读

#tutorial #beginners #webdev](/kbk0125/web-caching-explained-by-buying-milk-at-the-supermarket-9k4)

太好了。

在开发上，我们非常依赖通过我们的内容交付网络快速缓存。这意味着您的 dev.to 请求将到达离您最近的代理服务器(一个由 CDN 提供的服务器，存储我们最常见请求的文件),而不是一直到达原点。如果您的请求确实需要到达起点，我们也依赖 Rails 提供的开箱即用的缓存特性，它也存储静态的、准备就绪的信息。这意味着浏览器、CDN 和 Rails 一起工作，在请求直接进入新资产的底层代码之前完成请求。

`Browser Cache > CDN > Rails Cache > Underlying Code`

这都是非常常规的，所以 [Fastly](https://docs.fastly.com/) 和 [Rails](https://guides.rubyonrails.org/caching_with_rails.html) 文档是了解更多信息的绝佳资源。

如果你从事开发工作，有必要问一下:“这个应该被缓存吗？如果是，在什么级别？”或者反过来，“应该清除缓存吗？”在本文中，我们将重点讨论后者。

最近，我正在构建合并两个用户的功能——有时人们分别通过 twitter 和 github 登录(而不是链接他们)，这就创建了两个帐户。一个非常简单的过程:

*   将所有活动从账户 B 转移到账户 a。
*   删除帐户

完成上述操作后，可以合理地假设，当我访问帐户 A 的配置文件时，我会看到用户的所有合并活动。没有。我有一瞬间的恐慌，以为账户 B 的所有数据都被删除了。结果是，在我的代码中，我没有发出清除 Fastly 缓存的信号，因此请求没有接收到新的数据。是的，用户配置文件(/username)都被缓存，这意味着每当页面上的某些内容发生变化时，我们都需要清除缓存。

我们有一个缓存破坏对象，可以很容易地快速清除我们的缓存，以及一些方便的方法来清除需要定期清除的项目。这是处理所有逻辑的文件:`app/labor/cache_buster.rb`。下面是如何清除我的用户资料的缓存:`CacheBuster.new.bust("/jess")`。

当我在 Fastly 上清除帐户 A 的用户配置文件路径时，我希望看到所有合并的活动。这几乎是*的情况——文章、徽章和评论都出现了，但其中一个社交图标不见了(具体来说是账户 B 的原始登录方式)。原来我们利用低级 Rails 缓存来存储用户数据。当我更新帐户 A 的资料时，我没有运行任何会清除缓存的“保存”回调。为了清除这个 Rails 缓存，我需要正式更新用户——像`user.touch`这样的东西通常会这样做。*

 *我不认为在开发中运行高速缓存是可能的，但是通过切换`bin/rails dev:cache`，用一个简单的 rake 任务运行 Rail 的缓存*是*可能的。

最后一件事:除了所有这些，我们还使用了一个叫做[反主流文化](https://github.com/magnusvk/counter_culture)的宝石。这个 gem 跟踪用户的关联计数，比如`articles_count`，它帮助我们更快地查询。有时这些计数会不同步(比如当您更新用户活动时没有运行适当的回调...).如果您遇到这种情况，可以直接更新计数。例如:

```
user.articles_count = user.articles.size 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这是对我们缓存策略的一个“反向”观点，但我希望它能为开发应用程序提供一些见解。*