# 了解 AWS Lambda

> 原文:[https://dev.to/yloganathan/understanding-aws-lambda-4ia4](https://dev.to/yloganathan/understanding-aws-lambda-4ia4)

在 Peaksware，我们使用 AWS 解决方案来满足我们的无服务器需求。理解 Lambda 函数包括

1.  AWS 如何扩大/缩小规模并获取代码变更？

2.  了解 AWS Lambda 的同伴，如层和阶跃函数。

3.  编写 lambda 函数时的编码最佳实践。

本节中的基准测试信息是从王良和他的同事写的一篇详细的论文中总结出来的——窥视无服务器平台的幕后

## [](#scaling-up-lambda)放大λ

当一个请求进来时，AWS 在 AWS 的一个主机中的一个 VM 之上创建一个容器。容器有运行时和函数代码。调用函数，lambda 等待执行完成。执行停止于

1.  成功完成功能代码
2.  功能代码中的异常
3.  执行超时

随着更多请求的到来，AWS scheduler 可以使用同一个容器，在同一个虚拟机中运行新的容器，或者添加更多的主机和虚拟机。AWS 通过初始化多达 1000 个并发容器来处理并发请求。容器被紧密地打包在虚拟机中，以优化虚拟机的内存利用率。甚至来自同一个 AWS 帐户的两个不同的函数也可能共享同一个 VM。

## [](#cold-start)冷启动

*   冷启动可能涉及启动新容器、设置运行时环境和部署功能，这将比重用现有容器花费更多的时间来处理请求。
*   冷启动延迟随着分配的功能存储器的增加而减少。一种可能的解释是，AWS 根据内存大小按比例分配 CPU 功率；随着 CPU 能力的提高，环境设置变得更快。

## [](#scaling-down-lambda)按比例缩小λ

AWS 将保持容器空闲任意长的时间，以便更快地响应请求。AWS 将大约每 300 秒关闭一个函数的一半空闲实例，直到剩下两三个实例，并最终在 27 分钟后关闭剩余的实例。一台虚拟机可以运行 9 个小时。

## [](#updating-lambda-code)更新λ码

传入的请求可能会被旧版本的函数处理。调度器不是原子的，如果在有 50 个或更多并发请求访问函数时更新函数，3.8%的实例可能会运行不一致的版本。6 秒似乎是函数更新和请求之间的理想时间，以避免运行旧版本的函数。

您还可以通过使用蓝绿色部署方法(使用代码部署而不是直接更新函数)来防止这种情况。

## λ层

Lambda 函数在容器中执行，lambda 层是现有 lambda 功能的逻辑扩展。

*   代码大小(包括函数代码使用的所有库)应小于 50MB。
*   层是单独打包依赖项的好方法，这样可以减少部署包的大小。
*   层对于在多个功能之间共享公共代码非常有用。
*   一个函数最多可以有 5 层，最大代码大小为 250MB。

## [](#aws-step-functions)AWS 步进功能

`AWS step functions allows us to create a state machine by chaining together Lambda functions.`

在基于分布式微服务的架构世界中，微服务之间的协调是使用发布-订阅或事件流模型来完成的。AWS 尝试使用阶跃函数来抽象松散依赖函数之间的通信。步骤功能可以被视为帮助创建和可视化整个工作流程的功能编排器。

## [](#use-cases-for-step-functions)阶跃函数的用例

*   ETL 数据处理
*   将一些任务从单一服务器转移到无服务器服务器。
*   将 Lambda 函数编排到服务中。

[AWS 文档](https://aws.amazon.com/step-functions/use-cases/)提供了更多的用例及例子。

## [](#writing-code-for-lambda-functions)为 Lambda 函数编写代码

即使爆炸半径受到无服务器功能的限制，所有工程最佳实践仍然适用，只需进行一些微小的实施更改。

*   日志记录——使用提供的日志记录机制(CloudWatch ),并使用 ELK stack 将日志流带到一个中心位置进行进一步处理。

*   版本控制— AWS 提供了对功能代码进行版本控制的选项。版本是不可变的，并提供了在需要时回滚 lambda 代码的机会。

*   监控—使用 DeadLetterQueue、SNS topics 和 CloudWatch alarms 等工具获取故障通知。网关上的监视器 5XX、4XX。监控 Lambda 上的节流、错误和并发执行。

*   安全性——为 lambda 执行创建一个单独的角色，并只提供所需的特权。如果 lambda 可以访问任何私有资源，请将 lambda 置于 VPC 之后。

我们准备好运用这些知识了吗？继续看下一章。

接下来:[使用 Lambda、API Gateway、DynamoDB 和无服务器框架 S3 部署 web 应用](https://dev.to/yloganathan/deploying-a-web-app-using-lambda-api-gateway-dynamodb-and-s3-with-serverless-framework-4b1b)