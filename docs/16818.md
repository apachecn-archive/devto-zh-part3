# 在财务 API 设计中处理增值税

> 原文:[https://dev . to/jesperreiche/handling-vat-in-financial-API-design-63](https://dev.to/jesperreiche/handling-vat-in-financial-api-design-63)

如果你曾经在金融领域从事计算工作，你就会知道小数和四舍五入都非常重要，也非常烦人。当你舍入时，以及舍入到多少位小数，在一个问责至关重要且数字必须精确到小数点后第 n 位的行业中意味着很多。因此，你掌握的信息越多越好。尤其是当你不能控制所有的变量时。

例如，这可能是在设计 API 时。您所能进行故障诊断的，就是进入您的应用程序的属性值。除非你知道求和的各个部分，否则你不能对已经求和的东西进行反求和。API 输出的消费者也是如此。

谈到增值税，它既简单又非常复杂。它是简单的，因为它是一个添加的百分比，但是当它应该被添加时，它可能是复杂的。当然，如何处理在某些情况下有增值税和在某些情况下没有增值税的金额。

这种偶尔出现增值税的情况在内部代码/应用程序中处理起来已经足够复杂，但对于外部合作伙伴来说，它只会变得越来越复杂。因为那些在内部看来显而易见的常识，很少能在 API 之间传播——即使它可能在文档中。那么我们如何处理这种模糊性呢？

一个解决方案可能看起来有些过分，但在过去对我很有用，那就是用 3 个属性来表示所有的金额。如果这是月度价格，那么在我们的 API 中，我们应该有:

月度价格出口
月度价格进口
月度价格出口

拥有这种粒度可能看起来有些过分，因为你可以说你总是可以从其他两个中计算出第三个。这应该也是一个正确的假设。但是也有人反对这样做。首先，如果你计算它，那么你是负责任的。你触动了计算，所以现在你接管了控制权。在金融应用中，这可能是危险的，或者至少需要完全有意识地去做。另一个与小数有关，因此也与四舍五入有关。如果在四舍五入之前将两个金额相加，然后四舍五入到更少的小数位数，那么实际上可以得到“简单的”增值税金额，但这两个金额并没有相加。这看起来不太好，而且会导致花费大量时间去弄清楚为什么你的总和与你的消费者/合作伙伴的总和不一致。

如果消费者拥有计算权，那么你就不应该将自己置于一个不得不重新计算数量的境地，而这些数量本来是可以通过 API 提供的。那只是自找麻烦。拥有细粒度的 API 解决了这个问题。

另一个问题是有时包含增值税，有时不包含增值税的金额。通过接口进行通信的最佳方式是什么？

我们已经在上面定义了我们的金额结构，如果我们购买，那么我们如何处理有时包括增值税，有时不包括增值税。

如果我们坚持使用上面描述的结构，并且不添加额外的属性来指示金额是否包括不包括增值税，则有三个选项。

保持示例不变，第一个选项是当金额不包括增值税时，将 MonthlyPriceInVat 和 MonthlyPriceVat 设置为零。这不是一个好的解决方案，因为它打开了各种各样的问题，总数加起来非常奇怪，因为 InVat-amount 将是零。这也把责任推给了消费者。他们必须知道或者决定。

第二个选项是始终返回 InVat 并填写 Vat，即使当前金额应为 ExVat。这也许比上面的好一点。但是，它再次设置任意值，并导致求和误差。同样，关于在特定情况下的特定金额是否应该有或没有增值税的知识取决于消费者。

第三个选项，也是我推荐的选项，是将 ExVat 和 InVat 设置为相同的金额，并且当金额不包括 Vat 时，仅将 Vat-amount 设置为零。这样就避免了 InVat 上的求和误差。也很容易看出这个金额应该是不含增值税的。消费者可以使用他们所有的正常逻辑来处理金额，ExVat、InVat 和 Vat 将全部加起来达到正确的金额。即使混合了包含和不包含增值税的金额，也会得出正确的总额。