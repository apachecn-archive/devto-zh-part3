# 用真实的例子编写 Django 数据迁移

> 原文:[https://dev . to/guin/writing-a-django-data-migration-with-real-world-example-40m](https://dev.to/guin/writing-a-django-data-migration-with-real-world-example-40m)

大多数时候，当我们想到 Django 中的迁移时，我们指的是模式迁移。Django 可以自动为您创建这些，因为它们描述了数据库结构的变化，而不是数据本身的变化。然而，您可能会发现自己正在使用的另一种类型的迁移是数据迁移。当您加载新数据，或者想要使用特定模式更改数据库中的数据时，数据迁移非常有用。

我在构建纽约餐馆健康检查数据的搜索界面时遇到了这个问题。我希望我的应用程序的用户能够通过名称搜索餐厅，并查看所有的检查数据。数据集是一个 CSV 文件，其行对应于检验，但是，它有一个“camis”字段，这是一个企业的唯一标识符。我希望转换这些数据，以匹配我希望用于业务和检查的数据模型，并且我需要获得所有独特的业务。

如果您只是加载一个夹具或一些样本数据，而这些数据已经在您需要的结构中，您可能不需要数据迁移，但是可以使用 Django 提供的 [`loaddata`](https://docs.djangoproject.com/en/2.2/ref/django-admin/#django-admin-loaddata) 命令。

## [](#creating-a-data-migration)创建数据迁移

Django 不能自动为您生成数据迁移，但是您可以自己编写一个。您可以运行以下命令来生成一个空迁移文件，您将在其中添加操作。

`python manage.py makemigrations --empty yourappname`

我们将看到的、您将用于数据迁移的主要操作是`RunPython`。下面是自动生成的文件的样子:

```
# Generated by Django A.B on YYYY-MM-DD HH:MM from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('yourappname', '0001_initial'),
    ]

    operations = [
    ] 
```

`RunPython`需要一个 callable 作为它的参数。您将编写的这个函数有两个参数，一个应用程序注册表和一个模式编辑器。然后，我们在函数中添加`RunPython`操作。这将导致它在我们从命令行运行`./manage.py migrate`时被执行。

```
from django.db import migrations

def my_function(apps, schema_editor):
    # logic will go here
    pass

class Migration(migrations.Migration):

    dependencies = [
        ('yourappname', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(my_function),
    ] 
```

app registry 维护所有可用型号的历史版本列表。我们希望在函数中使用 app registry，通过使用`apps.get_model('your_app_name', 'your_model_name)`来获取历史版本，而不是直接导入模型。我们这样做是因为我们想要确保我们使用的是这个迁移所期望的模型版本。如果您使用直接导入，您可能会导入较新的版本。

SchemaEditor 可用于手动更改数据库模式。除了非常高级的情况，您很可能不想直接与之交互。SchemaEditor 将操作公开为[方法](https://docs.djangoproject.com/en/2.2/ref/schema-editor/#methods)，并将“创建模型”或“更改字段”之类的事情转化为 SQL。

RunPython 操作也可以接受第二个 callable。第二个函数将包含您希望在向后迁移时发生的逻辑。如果不提供，试图向后迁移将会引发异常。如果您想了解更多关于 RunPython 操作和其他可选参数的信息，请查看文档[这里](https://docs.djangoproject.com/en/2.2/ref/migration-operations/#runpython)

## [](#example)举例

让我们看一个直接从我的代码中移植 ickly 的例子。我已经添加了评论来指出我们在这篇文章中讨论过的所有相关部分。

```
# -*- coding: utf-8 -*-
# Generated by Django 1.10.1 on 2017-04-20 21:02 from __future__ import unicode_literals

from django.db import migrations, models
import csv
from datetime import datetime

def load_initial_data(apps, schema_editor):
    # get the correct versions of models using the app registry
    Business = apps.get_model("api", "Business")
    Inspection = apps.get_model("api", "Inspection")

    # This is where your migration logic will go. 
    # For my use case i needed to get unique businesses and 
    # transform data from the csv file into the schema i wanted 
    with open('DOHMH_NYC_Restaurant_Inspection_Results.csv') as csv_file:
        reader = csv.reader(csv_file)
        header = next(reader)

        businesses = []
        inspections = []

        for row in reader:
            camis = row[0]
            business = next((b for b in businesses if b.camis == camis), None)
            if not business:
                business = Business(camis=row[0], name=row[1],
                            address="{} {} {} {}".format(row[3], row[4], row[2], row[5]),
                            phone=row[6], cuisine_description=row[7])
                businesses.append(business)

            inspection = Inspection(business=business,
                                record_date=datetime.strptime(row[16],"%m/%d/%Y").date(),
                                inspection_date=datetime.strptime(row[8],"%m/%d/%Y").date(),
                                inspection_type=row[17], action=row[9], violation_code=row[10],
                                violation_description=row[11], critical_flag=row[12],
                                score=int(row[13]) if row[13] else None,
                                grade=row[14],
                                grade_date = datetime.strptime(row[15],"%m/%d/%Y").date() if row[15] else None)
            inspections.append(inspection)

        Business.objects.bulk_create(businesses)
        Inspection.objects.bulk_create(inspections)

## logic for migrating backwards def reverse_func(apps, schema_editor):
    Business = apps.get_model("api", "Business")
    Inspection = apps.get_model("api", "Inspection")

    Business.objects.all().delete()
    Inspection.objects.all().delete()

class Migration(migrations.Migration):
    # Django automatically adds dependencies for your migration
    # when you generate the empty migration
    dependencies = [
        ('api', '0002_auto_20170420_2101'),
    ]

    # the RunPython operation with the two callables passed in
    operations = [
        migrations.RunPython(load_initial_data, reverse_func)
    ] 
```

关于 Django 数据迁移还有很多需要了解的，但是现在您已经知道是否需要编写一个，如果需要的话，也知道如何开始了。如果你想学习更多关于 Django 迁移的知识，文档提供了一个很好的概述。

如果您有任何问题、意见或反馈，请告诉我。关注每周关于 JavaScript、React、Python 和 Django 的新帖子！

泰勒·维克在 Unsplash 上的封面照片