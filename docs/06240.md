# 为什么不应该使用(长期)特性分支

> 原文:[https://dev . to/jpdelimat/why-you-should-not-use-feature-branches-h68](https://dev.to/jpdelimat/why-you-should-not-use-feature-branches-h68)

上图中的 git 历史难道不好用吗？这个库中可能有很多问题，但是其中一个肯定是特性分支的使用。让我们看看这样的坏事是如何成为如此普遍的做法。

当 git 取代 SVN 时，它带来了一种简单得可笑的创建分支的方法。

> git 的理念是减轻开发人员一次处理多个特性的痛苦。不要把分支推来推去，把它们和你团队的整个开发过程联系起来。

当 JIRA 和其他人出现时，像 Atlassian 这样的公司开始大力推广“git 工作流”和特色分支。“创建分支”按钮出现在你的 JIRA 任务中，然后嘣，特色分支诞生了！Atlassian 在[这篇有趣的文章](https://www.atlassian.com/agile/software-development/branching)中告诉你这一切。我很喜欢 Atlassian 的产品。请记住，他们的核心业务是开发团队的任务管理。它与分支和代码越纠结越好。

十年后，特性分支是大多数团队的标准，而事实上它并没有给你的底线带来任何好处:将高质量的软件发布到产品中。功能分支不仅没有带来任何好处，实际上还会降低你的速度！

为了清楚起见:本文假设一个特性分支将承载你正在开发的全部特性，并且是一个所谓的“长期”特性分支，将持续 1 周或更长时间。这不是一个“没有任何分支”的咒语。

## [](#the-feature-is-ready-i-just-need-to-merge%C2%A0it)“功能就绪。我只需要合并它！”

这种话我听了太多次了。这与“它可以编译，所以它可以工作”的说法属于同一类。

实际上，合并导致了“不可预测的发布综合症”。它可能很快出现，也可能表现出一个重大的不兼容性，需要迅速解决。你要么很幸运，要么……你的时间线改变了，代码质量下降了。

> 特性分支的真正问题是它们如此受欢迎的原因:它们激发了开发者的自豪感，让你对自己的工作感觉良好。

你的特色树枝是你自己的完美花园，你可以保持它的干净和闪亮。但是它和你队里的其他花园是分开的。越是分开工作，越是难以调和。

我是管理学书籍《目标》的忠实粉丝。它显示了随着时间的推移，人们如何倾向于使用突出过程的局部最优的度量，因为这样更舒服。他们只是失去了对全球底线的关注。这本书是关于一个生产工厂的，但类比仍然成立。您的特征分支是具有高质量代码的局部优化。也可能离主分支太远，对即将发布的版本没有用。

## [](#trunk-based-development-to-the%C2%A0rescue)干线基础发展到救援

顾名思义，在基于主干的开发中，整个团队不断地向主分支推进，或者使用非常短暂的(最多 1 或 2 天)分支。

这里有一个[想法的详细描述](https://trunkbaseddevelopment.com/)。我与链接的网站没有关系。这只是一个很好的概念概述。

当你经常将工作推到主分支时，要合并的代码量就会变得更少，变得微不足道。不过还有一个更大的好处:你和你的团队可以在问题变得棘手之前发现它们。可能是你的重构与另一个特性冲突了。或者您正在偏离项目惯例或架构模式。这才是过程的真正价值。当我在任何我发现自己身处的地方布道时:

> 团队合作决定了软件项目的成败。

对一个团队来说，花几天时间编写永远不会按时发布的代码是最大的失败。

经常向主分支推进或合并的另一个好处是，您的更改将在某些环境中实时运行。部署和测试你的代码总是好的，即使是在实际的部署过程中。

## “WIP”在主分支？

如果你读到这里，你可能会想“这太疯狂了，我怎么能把我已经完成一半的工作推到主分支，而它可能很快就会被部署到生产中！？!"。

以下是人们可能会有的常见异议和暂定解决方案。

### [](#how-can-i-expose-unfinished-work)如何曝光未完成的作品？

使用功能切换。它们可以是环境变量或者任何最适合你打开和关闭你正在进行的工作的变量。当然要使它具有防御性，这样你的半成品代码就不会错误地在生产中被激活。

你的整个团队都会喜欢这个:你可以在任何时候在任何环境下激活代码，看看它看起来或者执行起来如何。测试人员可以在早期准备测试。产品负责人可以一路评论你的工作。这一切都是实时的，每个人都可以轻松访问！如果你的工作就像刚刚开始，这提供很少的价值。但邪恶存在于细节中。完成 90%通常需要一半的时间，完成剩下的 10%需要一半的时间。在这种完成 90%的状态下分享你的作品总是一个好主意；)

另一件免费的事情是:如果部署后出现问题，您可以在生产中关闭该特性。几天或几周后，一旦特性运行顺畅，只需从代码中移除切换。

### [](#what-if-i-break-the-main-branch-for-everyone)如果我给大家折断主枝呢？

现在是 2019 年。如果你没有自动构建和运行测试的持续集成设置，那么昨天就设置好了。如果你打破了任何东西，在它成为整个团队的问题之前，你会得到通知。在纯基于主干的开发中，反馈会在合并后出现，并且必须立即修复。如果您使用的是短期分支，您的 CI 工具应该会阻止合并。一个短命的分支应该最多持续 1 到 2 天，并且包含一段对你正在构建的特性有贡献的一致的代码。

### 在我们合并任何东西之前，必须有一个代码审查！

那是一个有效的观点。尽管代码评审不需要特性分支。如果代码审查文化在你的团队中很强，那么它可以在提交到主分支时很好地完成。评审者会在提交的作者旁边停下来，讨论什么需要修改。修复将在另一次提交中进行。更好的是，在提交之前，一起检查代码。

如果你的团队不能接受合并后的代码评审(因为让我们面对它，它不太方便，因为工具并不真正支持它)，使用短期的分支，并在那里应用你的代码评审过程。

### [](#i-want-to-see-the-code-that-is-related-to-a%C2%A0task)我想看与任务相关的代码

如果每个特性都有一个给定的分支，那么追踪代码回到您的敏捷董事会就很容易了。您可以从一个任务导航到实现该任务的分支。

这听起来很酷，而实际上这是没有用的！一个敏捷团队可以有多少人？高达 5？最多 10 个？问运行一个任务或故事的人你需要查看哪些提交来深入实现有多难？

一段时间后，一旦任务完成了很长时间，将任务与代码联系起来就不再有意义了。开发人员依靠 git 责备来知道是谁，依靠代码内容来知道如何做，希望依靠注释来知道为什么。

### 蛋糕上的樱桃:选择加入新功能

使用“选择加入”方法发布主要的 UI 特性或更新变得很常见。Github、Bitbucket、Gmail、……不一而足。

这个概念是，主要的变化是采用横幅“嘿，我们有这个新功能/改进的仪表板/什么的。单击此处试用”。你可以选择加入，如果你不喜欢这种改变，通常也可以选择退出。这是一个非常好的采用测试策略，因为它让最终用户参与到决策过程中。如果人们选择加入并停留在那里，这意味着你正在改善体验。如果他们选择进出…你知道你已经把事情变得更糟了。

如果您从一开始就使用特性切换，那么在运行时在每个用户的基础上公开这些特性将变得非常容易。

## [](#conclusion)结论

如果您从未想过将基于主干的开发作为特性分支咒语的替代方案，我希望这篇文章能给您一些视角，并愿意尝试一下。

最好的事情是，为了达到这个目标，你需要设置或改进过程的每个其他方面(CI、自动化测试、代码审查)。这是一条很好的道路。我们明显推荐 Fire CI 作为[持续集成工具](https://fire.ci)。

记住你的底线是把高质量的软件放在你的用户面前。您的代码始终离生产环境越近越好。

现在，尽管这篇文章很大程度上是面向“基于主干的开发”,但是请注意，对于您的团队来说，这可能不是一个有效的方法。如果你的团队高度分散，在不同的时区，有许多需要学习项目惯例和架构的初级开发人员，使用寿命更长的特性分支可能会更好。

这篇文章的主要思想是:

> 你越快地将不同的部分集成在一起，并检查事情是否正常工作，最终你就越安全地拥有一个工作产品。

一个很好的共同点是使用最多持续 1 或 2 天的短期分支，并将它们合并到主分支中。这样，您可以人工控制进入的内容，并且仍然可以快速集成代码。

原载于 2019 年 3 月 30 日[火词博客](https://fire.ci/blog/why-you-should-not-use-feature-branches/)。