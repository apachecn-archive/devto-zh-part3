# 对关键漏洞的剖析

> 原文:[https://dev . to/Turner j/the-anatomy-of-a-critical-vulnerability-51fe](https://dev.to/turnerj/the-anatomy-of-a-critical-vulnerability-51fe)

**注意:这一点在被发现后立即被负责任地披露给了 SilverStripe。截至 2 月 18 日，silver stripe(CVE-2019-5715/SS-2018-021)已经公开披露了[，发布了所有支持版本的补丁。](https://www.silverstripe.org/download/security-releases/ss-2018-021)**

在我过去 7 年工作的地方，我们主要用 PHP 建立网站，特别是 T2 的 SilverStripe。在我离开之前，给同事们的最后一个小惊喜是，我发现了 SQL 注入的一个漏洞。

在详细介绍安全漏洞之前，我需要解释一下 SilverStripe。

## [](#silverstripe)银色条纹

SilverStripe 是一个开源的 PHP 内容管理系统。在它的核心，有一个`DataObject`类，基本上所有写入数据库的东西都使用它。那就是从你的`HomePage`班到你的`ImageSlide`班再到你的`Member`班。

典型的`DataObject`可能看起来像这样(为了简洁，去掉了名称空格):

```
class MyCustomObject extends DataObject
{
    private $db = [
        'MyProperty' => 'Varchar'
    ];

    private $has_many = [
        'Slides' => ImageSlide::class
    ];
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

当您拥有这些对象之一的实例时，您可以通过神奇的方法读/写`MyProperty`:

```
$myPropertyVal = $myCustomObject->MyProperty;
$slides = $myCustomObject->Slides();

$myCustomObject->MyProperty = 'Hello world!';
$myCustomObject->write(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这是获取和设置值的主要方式。还有其他帮助方法可以从数组等中批量设置这些值。

这就是你所需要知道的，来理解即将到来的问题的要点。

## [](#discovery)发现

虽然我确实发现了这个问题，但在发现过程中有两件重要的事情需要提及:

*   我们的一个站点正在通过一个自动漏洞测试系统进行安全审计。一个特定尝试的错误给我指出了正确的方向。
*   当我向 SilverStripe 披露这一问题时，他们发现了进一步扩展这一漏洞的问题。

由自动安全审计触发的错误与名为 [SwipeStripe](https://github.com/swipestripe/silverstripe-swipestripe) 的 SilverStripe 模块有关，但这不是该模块的错误，只是在这种情况下最初通过该模块暴露出来。

有一个带有特定`update`方法的`OrderForm`类，这就是问题的开始:

```
public function update(SS_HTTPRequest $request) {
    if ($request->isPOST()) {
        $member = Customer::currentUser() ? Customer::currentUser() : singleton('Customer');
        $order = Cart::get_current_order();
        //Update the Order 
        $order->update($request->postVars());
        $order->updateModifications($request->postVars())
            ->write();
        $form = OrderForm::create(
            $this->controller, 
            'OrderForm'
        )->disableSecurityToken();
        // $form->validate();
        return $form->renderWith('OrderFormCart');
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这是一个问题。对`$order`对象的`update`函数调用是一个内置的 SilverStripe 函数，在这里你传递一个字段数组，它会为你设置它们。将 POST 变量直接传递给它是一个非常糟糕的想法(您应该正确地检查您的字段),但是我离题了。

SilverStripe 通常会安全地准备查询，所以 SQL 注入不会发生，但有一个边缘情况，它不工作。

事实证明，如果您的 POST 请求看起来不像`SomeProperty=1`而更像`SomeProperty[MySneakySQLStatement]=1`，事情就会变得奇怪，跳过准备好的语句的工作方式，并在原始查询中结束。

这个问题出现在这里是因为`postVars`将`SomeProperty[MySneakySQLStatement]=1`返回到类似于
的东西

```
{  "SomeProperty":  {  "MySneakySQLStatement":  1  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

如果在内部它看起来更像下面这样，它可能不会成为一个问题:

```
{  "SomeProperty[MySneakySQLStatement]":  1  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

现在，要真正利用漏洞，比仅仅在字段名中添加 SQL 查询稍微复杂一点，但是您已经明白了。

我把我所知道的一切都交给了 SilverStripe，他们从那里接手，发现这个问题比看起来要大一些。

## [](#the-actual-issue)实际发行

就利用这个问题的方法而言，我没有错，但这不是唯一的方法。事实证明，我前面提到的`update`函数并不是问题所在，而是它所依赖的代码基本上支持所有对数据库的写入。

在 SilverStripe 关于这个问题的博客文章中，他们声明:

> DataObject 上的直接赋值(update()、通过方法调用的 setter、通过魔术方法的 setter)和间接赋值(如 Form->saveInto())都会受到影响。

所以不仅仅是我最初注意到的`update`方法，基本上所有的写作方法都受到了影响！这个 bug 刚刚从“不好，但不太可能影响很多人”变成了“哦，这可能会影响每个人”。

他们在博客上写道:

> 该漏洞与支撑 DataObject 逻辑的 DBField 类有关。SilverStripe 3 中的大多数 DBField 类型都会受到影响。在 SilverStripe 4 中，只有 DBYear 字段类型被确认会受到影响，这将我们当前发布系列中的影响限制在相对不常见的用例中。

虽然仍然是一个严重的漏洞，但通过其他修复和改进，SilverStripe 的最新主要版本(版本 4)受到的影响较小，这是一件好事。

## [](#the-fix)修罗

该修复实际上相当小，分为 5 个文件(针对 SilverStripe 4)，你可以在这里看到。

这实际上相当于重复检查字段赋值不是数组。

例如，在`DataObject`类的一部分:

```
// Make sure none of our field assignment are arrays
foreach ($manipulation as $tableManipulation) {
    if (!isset($tableManipulation['fields'])) {
        continue;
    }
    foreach ($tableManipulation['fields'] as $fieldValue) {
        if (is_array($fieldValue)) {
            user_error(
                'DataObject::writeManipulation: parameterised field assignments are disallowed',
                E_USER_ERROR
            );
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#conclusion)结论

总是，总是，总是负责任地披露安全问题。感谢 Matt、Maxime、Ingo 和 SilverStripe 的所有人测试并解决了这个漏洞！🙂

对于 SilverStripe 用户，你可以在这里查看所有安全发布[或者在这里](https://www.silverstripe.org/download/security-releases/)查看安全发布流程[。](http://docs.silverstripe.org/en/contributing/release_process/)