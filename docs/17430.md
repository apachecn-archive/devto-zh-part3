# 管道:不只是白日梦

> 原文:[https://dev . to/_ mor gan _ ADAMS _/pipelines-not-just-a-pipe-dream-15p 5](https://dev.to/_morgan_adams_/pipelines-not-just-a-pipe-dream-15p5)

# [](#the-joke-testing-in-production)笑话:生产中的测试

“生产中的测试”已经成为开发世界中一个常见的笑话——主要是因为我们中的许多人都经历过，想想就有点刺痛。你可能听说过这些开发管道，但在调查后，认为这是一个太大的投资，事实是它们并不便宜！持续交付不是你应该尝试并在一夜之间吐出来的东西。

每个人都希望有信心，当他们将代码部署到生产环境中，并且让 ***知道*** 他们的代码已经准备好了。在拥有某种管道之前，每次发布都像《侏罗纪公园》中的场景，塞缪尔·杰克逊开始恢复供电。

[![Hold on to your butts](../Images/f7d4d7bf757bcd5fae82513b55217cb6.png)T2】](https://i.giphy.com/media/OCu7zWojqFA1W/giphy.gif)

那么，我们如何才能确信我们的代码已经准备好投入生产了呢？管道！

# [](#what-is-a-pipeline)什么是管道？

让我们从对这个想法比较新的人的一些定义开始。

*   管道-(来自 git lab[https://docs.gitlab.com/ee/ci/pipelines.html](https://docs.gitlab.com/ee/ci/pipelines.html))

    > 管道是一组分阶段执行的作业。一个阶段中的所有作业都是并行执行的(如果有足够多的并发运行者)，如果它们都成功了，那么管道就进入下一个阶段。如果其中一个作业失败，下一个阶段(通常)不会执行。您可以在项目的“管道”选项卡中访问“管道”页面。

*   环境——你的代码为了某个特定的目的而运行的地方

*   staging——一组计算基础设施，在部署到客户之前，运行您的代码进行集成测试、用户体验测试、渗透测试和其他测试

*   生产——运行客户看到的代码和存储客户数据的一组计算基础设施

换句话说，一旦我们把一些代码放在一起，我们首先要把它部署到某种看起来像生产的阶段环境中，测试一些东西，然后投入生产。理想情况下，您的暂存环境看起来与生产环境完全一样，但是如果您资金紧张，那么本地虚拟机、 [Docker](https://www.docker.com/) 容器或它们在云中的对等物也能很好地工作。关键是你要测试你的构建，以确保它在投入生产之前实际运行*。*

不幸的是，管道可能比这更复杂。以下是一些组件，它们可能会也可能不会出现在您的最终产品系列中:

*   合并请求
*   犯罪
*   变更日志
*   构建应用程序
*   代码分析
*   单元测试
*   集成/API 测试
*   性能测试
*   多个环境(试运行(通常分为多个环境)、生产)
*   烟雾测试
*   回归测试
*   视觉回归测试
*   发布候选人
*   版本控制
*   提升到生产
*   黑暗发射
*   基于百分比的部署(第 1 天至 10%的客户)
*   自动化部署
*   韵律学
*   反转

我们可以很容易地继续增加这个列表，但是对于资源有限的组织或不熟悉管道的组织来说，这可能已经显得过多了。老实说，许多组件将取决于您的组织需要什么，您可能不需要那里的所有东西。

我之前提到的 Gitlab 链接让它变得非常简单[https://docs.gitlab.com/ee/ci/pipelines.html](https://docs.gitlab.com/ee/ci/pipelines.html)，但是它也有一个支持构建管道的特性集，所以如果你不使用 Gitlab，你就必须使用其他软件。这是他们在页面上使用的一个很好的技术不可知论的图表，显示了你的管道在高层次上可能是什么样子

[![Pipeline diagram](../Images/ecfe27ebf38ad6e62eb6889c67c78991.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--nYwdPXO4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://docs.gitlab.com/ee/ci/img/pipelines-goal.png)

# [](#so-where-do-you-start)那么从哪里开始呢？

从哪里开始可能取决于可用的资源。如果你手头拮据或独自经营一个项目，你仍然可以有一个管道！如果你有资源开始建立一个管道，但只是刚刚开始，没有问题，因为我会建议从同一个地方开始。

1.  创建一个可以构建您的软件的脚本
2.  创建一个脚本，一旦构建好就可以部署您的软件。如果您有一个可用的临时环境，也可以重用它来部署到临时环境。
3.  创建一个可以回滚到先前版本的脚本

反正你已经在做这三件事了。您也可以使用脚本来自动化这些步骤。以后你可以用更复杂的东西来代替它们。

# [](#next-steps)下一步

一旦你有了这三个部分，你就可以开始用最少的投资引入其他组件。

*   如果你没有运行一个单独的项目，确保代码评审是你的过程的一部分。
*   每次接触代码时开始添加单元测试。运行构建时，添加几行代码来执行单元测试。顺便扔个棉绒进去。
*   添加某种临时环境。通过一点脚本，你可以在 AWS 甚至本地 VM 中做一些 phoenixable(快速创建/销毁)的事情(运行一个本地容器，或者检查一下[流浪者](https://www.vagrantup.com/))。你有选择。
*   使用类似 git 标签/docker 标签的东西来给你的代码版本化。
*   维护变更日志

您可以下载免费的工具或模块来帮助您完成这些步骤。几乎每种语言都有测试库和测量代码覆盖率的方法。你也可以很容易地找到棉绒。

# [](#why-bother)何苦呢？

我在凌晨 2 点接到的电话比我想象的还要多——有时是连续几个晚上！当你在凌晨 2-6 点调试产品时，这是一个黑暗的地方。

对一个好的管道的投资将会为您省去许多痛苦和心痛，并且最终会让您对您和您的组织发布高质量软件的能力充满信心。更好的是，您的客户会更加满意。

# [](#make-progress)上进

您可以做很多事情来改进您的开发管道。你不必全部都做。慢慢开始，慢慢开始。你甚至不需要遵循我的建议，从适合你/你的团队的事情开始。识别速赢。在这个过程中，有很多工具可以帮助你。

最终你会发现大多数事情都是自动化的。自动化管道中我最喜欢的部分是在部署到生产环境之后，您有监视器来监视您的指标，确定您的新版本正在发送页面时间，并触发自动回滚或至少是您可能需要回滚的通知。然后我可以在凌晨 2 点醒来，按下按钮回到过去，继续睡觉！

以下是一些关键原则

*   无论是额外的单元测试还是自动化某个部分，每次接触代码/管道时都让它变得更好一点。
*   寻找快速的胜利。其中一些可能会节省你大量的时间。
*   如果你有一个长的发布周期，一个好的管道可以帮助你确保发布前的质量。
*   注重质量。如果新功能总是出错，它对任何人都没有帮助。
*   能不生产就不要急于生产。
*   不要在生产中测试！
*   睡得更好

我喜欢高质量的管道。你见过哪些好用的？你想补充什么？你想看我多谈些什么？如果大家感兴趣，我很乐意提供更多细节。