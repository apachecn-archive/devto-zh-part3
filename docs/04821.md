# 看在上帝的份上！构建可扩展的监控系统

> 原文:[https://dev . to/Molly/for-the-love-of-bleep-the-scalable-monitoring-system-520](https://dev.to/molly/for-the-love-of-bleep-building-a-scalable-monitoring-system-520)

作为一名[站点可靠性工程师(SRE)](https://dev.to/molly_struve/what-it-means-to-be-a-site-reliability-engineer-32ki) ，我的工作之一就是确保我们的应用程序有一个可靠的监控系统。如果你不知道东西什么时候坏了，你就不能保证可靠性。因为这个事实，我们的 SRE 团队在成立时增加的项目之一就是彻底检查我们在[肯纳](https://www.kennasecurity.com/careers/)的监控系统。

# [](#in-the-beginning)开始...

肯纳的监控系统是一场灾难。回想起来，至少我们有过一些东西，但离理想还差得很远。这是我们用来监控基础架构的内容。

1.  性能监控的新遗迹
2.  应用程序运行状况监控的责任
3.  使用日志来警告数据差异或站点使用异常的 Elastalert
4.  每晚每 30 分钟运行一次的 Cron 作业，用于查找数据异常
5.  针对应用/代码错误的蜜罐
6.  Sidekiq 和 Resque 等后台处理服务的管理仪表板

灾难不止于此！我们不仅有 6 种不同的工具进行监控，还让它们向所有不同的地方报告。

1.  松弛通道——在最坏的情况下，我们为每个单独的环境提供不同的松弛通道，并向其发送警报。
2.  短信服务
3.  电子邮件
4.  电话

似乎所有这些不同的警报媒介还不足以让你头晕目眩，我们发送给它们的警报却非常不一致。一些警报仅报告数据，但不需要任何操作。许多警报会周期性地响起，并且是误报。最后，有些警报实际上需要有人立即处理。

那些随叫随到的就不用说了，惨！他们不知道什么是重要的，也不知道哪些警报是可操作的。起初这并不是一个大问题，因为我们团队中的大多数人已经工作了一段时间，知道与哪些警报相关的所有细节。然而，随着我们团队的成长，我们意识到我们的监控系统需要改变。我们新成立的 SRE 团队很快决定，我们要解决的首要问题之一就是监控。

在几个月的时间里，我们彻底检查了我们的整个系统，这些改变取得了显著的成效。以下是我们实施的策略，这些策略为我们的团队带来了巨大的变化。

# [](#consolidate-monitoring-to-a-single-place)将监控集中到一个地方

所有东西都必须放在一个地方。当你的团队越来越大时，这一点尤其重要。随着越来越多的人加入，如果你不得不教他们多种不同的系统，就很难让他们加入进来。相反，教每个人一个单一的系统要简单得多。然后，当有人随叫随到时，告诉他们打开一个网页就行了，这样简单多了。您可以拥有多个报告工具，但您需要通过一个界面发送所有警报。

我肯定你想知道我们合并的地方是哪里。是[数据狗](https://www.datadoghq.com/)。我们选择 Datadog 的原因是因为它可以与我们所有的其他服务挂钩，这意味着所有东西都可以放在一个地方。我们将它连接到 Honeybadger 来跟踪应用程序错误，将它连接到 CircleCi 来提醒我们部署失败。你说吧，我们现在就在数据库里搜索。当有人打电话时，他们只需打开 Datadog 监控页面，了解应用程序的状态。

现在，数据狗不是你唯一的选择。有很多其他公司也在做类似的事情，你可以去看看。这里有一些其他建议的链接。

*   [https://alternativeto.net/software/datadog/](https://alternativeto.net/software/datadog/)
*   [https://www.quora.com/What-are-alternatives-to-Datadog](https://www.quora.com/What-are-alternatives-to-Datadog)

你也可以自己动手卷。我们曾经考虑过这一点，因为我们已经在应用程序中创建了许多自己的警报工具。然而，我们决定反对它，因为我们没有时间或资源来做好它。

# [](#make-all-alerts-actionable)使所有警报可操作

当你让一个噪音通过的时候，你就设定了一个优先顺序，其他的都被忽略了。我怎么强调这一点都不为过！一旦你开始忽略假阳性，你会很快忘记什么是重要的，什么是不重要的。如果警报响起而没有采取行动，那么该警报就不应该首先响起。如果你想提醒那些不可操作的东西，你需要把它们放在一个独立的地方，远离可操作的东西。

例如，实现这一点的一种方法是使用两个不同的松弛通道。您可以为必须处理的警报建立一个松弛通道，并为状态报告建立第二个通道。无论你选择怎样做，都要确保行动项目和“不需要行动”的对应项目是分开的。

# [](#make-sure-alerts-are-mutable)确保警报是可变的

这对我们来说意义重大！开始时，我们的许多手动滚动警报会每 30/60/90 分钟触发一次。即使我们已经确认了警报并正在修复它，它仍然会 ping 我们。没有什么比试图解决一个问题，而你的耳边却响起了警报更令人沮丧的了。

[![](../Images/aba4a4a8894fbf663a685bb6303a8113.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--diAgFPg0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4hs6jcojgzldy3yydi8y.gif)

我们首先试图通过使我们的手动滚动警报可变来解决这个问题。这有点工作，但必须通过控制台完成，命令不直观。此外，我们还收到了来自 Elastalert 等工具的警报，我们无法将其静音。考虑到我们所有工具之间的所有不一致性，当我们通过 Datadog 获得这一功能时，这是一股新鲜空气。

您不仅希望警报是可变的，理想情况下，您还希望能够在特定的时间段内将其静音。最糟糕的事情莫过于静音警报，解决问题，然后忘记取消静音。这可能会导致在某个时候错过警报。

# [](#track-alert-history)跟踪预警历史

这是一件你不会想到的事情，直到你盯着一个警报，不知道是什么引起的。很多时候，为了找出警报的原因，您需要知道之前的行为是什么。如果您有警报的历史记录，您可以这样做。通过回过头来寻找数据中的趋势，您可以更好地了解情况，这有助于找到根本原因。

拥有警报历史记录还可以帮助您发现趋势，甚至在警报被触发之前就发现问题。例如，假设您正在跟踪数据库负载。如果您突然经历了大量的增长，您可以参考该警报的监视历史，以评估数据库上的负载以及您是否接近该警报阈值。然后，您可以使用这些信息在警报响起之前提前发出警报。

# [](#the-payoff)胜负

彻底改革我们的监控系统在许多方面都取得了成效。首先，随叫随到的开发人员要开心得多！通过消除关于哪些警报重要，哪些不重要的任何模糊性，我们消除了待命时的许多困惑。我们还去除了很多噪音。当他们随叫随到的时候，没有人希望他们的电话整夜响个不停。删除这些误报修复了这个问题。

因为所有的监控现在都在一个地方，所以开发人员理解和学习起来简单明了。这种易用性促使许多开发人员通过制作他们自己的警报和改进我们已经有的警报来为警报工作做出贡献。拥有一个可靠的、易于使用的系统给了开发人员一个很好的理由去购买它并加入到改进它的努力中来。

我希望在您构建自己的警报和监控系统时，您能记住这些策略，以帮助您构建让每个人都乐于使用的东西！