# 如何将整体架构转变为无服务器架构

> 原文:[https://dev . to/Kyle Galbraith/how-a-monolith-architecture-can-transform-to-server less-8l 4](https://dev.to/kylegalbraith/how-a-monolith-architecture-can-be-transformed-into-serverless-8l4)

围绕无服务器的受众越来越多，许多人渴望利用它提供的优势。围绕无服务器有许多不同的资源，但它们往往侧重于如何开始。他们倾向于关注如何使用无服务器架构构建全新的东西。

但是，这遗漏了更多的观众。那些现有的代码库很难转移到无服务器。他们通常会背负一大笔技术债务。它们让无服务器看起来只不过是一个幻想。

因此，在这篇文章中，我想集中讨论一个整体应用程序如何随着时间的推移转变成无服务器的。

我们已经知道，任何全新的东西都可以使用无服务器构建。但是，我们如何利用我们今天拥有的应用程序或服务，并使成为无服务器的呢？最简单的答案是我们重写它。但是从开发的角度来看，这是昂贵的，并且取决于需要重写什么。

我建议我们在开始重写代码库之前暂停一下。让我们看看如何将现有应用程序的组件移动到无服务器环境中。通过这个过程，我们可能会发现进展顺利的事情以及我们可能会遇到的潜在棘手问题。一旦我们有了这两样东西，我们就可以制定一个计划，如何将我们的遗留应用程序，或者至少是它的一部分，移动到无服务器状态。

### [](#thinking-about-serverless)思考无服务器

围绕无服务器有一场健康的辩论。它有优点，也有缺点，甚至它的定义都有待讨论。这不是一个我打算再次讨论这些事情的帖子。但是，我认为分享与我产生共鸣的定义是有价值的。

> 无服务器是一种云优先的架构，它让我可以专注于向最终用户交付代码。底层服务器没有配置、维护、修补和容量规划。支持大大小小工作负载的规模和可用性由云提供商处理。

在理想世界中，无服务器使我不必处理运行代码的服务器。有了这种自由，我可以专注于为我的最终用户提供价值的代码。这是我心目中无服务器的核心。有时是理想主义吗？是的，作为开发人员，维护服务器并不是我们唯一要做的与代码无关的事情。但是这个想法还是值得努力的。

因此，当我考虑将现有服务转移到无服务器时，我会强迫自己考虑成本和回报。像任何其他建筑科技债务决策一样。现实情况是，做出技术性债务决策具有挑战性。衡量每一种方法的成本和回报是复杂的、不平凡的，而且很难做到完美。

因此，当我们探索将遗留代码转移到无服务器的想法时，我们应该承认这是一个很难解决的问题。它有许多解决方案，有些比其他的好，有些甚至不值得去做。但是，让我们至少探索一下如何从一个大型的单一应用程序转移到一个无服务器架构。

### [](#step-1-grounding-ourselves-in-reality)第一步:让自己在现实中扎根

首先，让我们现在就把它放在那里:

```
$ echo 'Not everything fits into the serverless model.' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

当您考虑无服务器时，这是一件非常重要的事情。**不是对所有事情都有效**，至少今天不是。

也就是说，它确实适用于很多事情，其中一些事情对你来说可能并不直观或自然。请记住，这是一个不同于我们今天使用的范式。但是这与我们已经编写的应用程序没有太大的不同。

当考虑投入精力将我们当前的架构转变为无服务器架构时，以现实为基础非常重要。建立一个清晰的理由，说明为什么您*认为*迁移到无服务器最适合您的应用或服务。如果你过不了这个阶段，你应该重新评估你将要走的路。

这些原因对你和你的工作量来说是独一无二的。因此，请考虑一下您希望通过迁移到无服务器系统获得什么。您的驱动原因可能是成本，您不想为每天 1-2 小时的流量支付全天候运行的服务器。这可能是规模。您希望在不负责底层基础设施的情况下获得可伸缩性。

无论你迁移到无服务器的原因是什么，确保你确认了它的重要性是你认为的那样。接下来的每一步都将是一个挑战，并将考验你的推理能力。

一旦我们让自己立足于我们想要实现的现实，就该开始评估我们的应用程序了。

### [](#step-2-dividing-the-movable-from-the-unmovable)第二步:区分可动与不可动

这就是乐趣的开始。是时候开始考虑你的应用程序中哪些东西可以立即转移到无服务器，哪些东西你认为不能。

这里没必要想太多。在你的巨石中很容易移动的东西往往会突然出现在你面前。与从一开始就看起来困难的事情相比，现在搁置起来可能更好。

在这个阶段，考虑无服务器架构中存在的约束通常是有帮助的。

*   根据您的无服务器云提供商，单个功能的执行时间为 1-15 分钟。它需要启动，完成必要的工作，然后退出。这个时间限制是可配置的，所以验证一下你*认为*完成工作需要多长时间，然后设定你的时间限制。
*   冷启动延迟是真实的。根据您的使用情况，您可能会注意到第一次调用无服务器功能时会有相当大的延迟。有很多因素会导致这种情况，有很多事情*你可以做*来帮助减少这种情况。
*   磁盘大小限制是需要记住的另一件事。在无服务器功能中，您通常没有千兆字节的存储空间供您使用。但是，如果需要的话，你通常会有某种类型的`tmp`或暂存存储器。
*   内存也受到限制，根据您的云提供商，您最多可以拥有 3GB 的内存。与这里列出的其他限制相比，这种限制要小一些，但是记住这一点仍然很重要。

当我们考虑我们的整体结构的哪些部分可以移动，哪些部分不可以移动时，记住这些核心约束是很重要的。围绕部署大小、有效负载大小、环境变量和文件描述符还有其他约束。但是，这些限制仅适用于少数工作负载，可能对您来说并不重要。

需要注意的一点是，这些约束是可以解决的。然而，当你开始这个旅程时，你应该暂时避免那些工作负荷。当你是新来的时候，他们可能会失控。我可以向您保证，最初还有其他更容易过渡的工作负载。

这里有一些我认为可以从一开始就把**移动到**的高级东西。*注意:这里提到的服务是特定于 Amazon Web Services 的，但是适用的服务存在于 AWS 之外。*

##### [](#cron-jobs)克朗乔布斯

CRON 作业是一个很好的起点，只要它们符合上面提到的约束。这些往往是我们都在运行的自动化流程，通常为我们做一些平凡的任务。如果你幸运的话，它们运行在自己的实例上，这意味着当你把它们转移到无服务器时，你就可以杀死一个实例💀

这些工作也往往在应用程序或服务的主要开发流程之外。也就是说失误的爆炸半径可能更小。因此，CRON jobs 是开始无服务器之旅的好地方。您可以熟悉这种范式，学习一些经验，获得一些价值，希望不会打扰您的用户。

##### ‘胶水’服务

我肯定有一个比‘胶水’更专业的术语，但让我解释一下我心目中的这些服务是什么。首先，服务在这里是一个松散的定义。它可以是一个运行在自己实例上的独立服务，也可以是你的整体内部的一个服务层。

粘合服务是充当一个或多个其他服务之间的中介的服务。换句话说，它将两个服务粘合在一起。这些服务经常在服务之间进行转换或传递消息。因此，只要它是无状态的，这种工作负载就可以很好地适应无服务器。

将这些类型的服务转移到无服务器意味着您需要考虑它们的合同。这个工作负载如何接收输入，如何传递输出？如果您已经使用 HTTP，可以通过 API 网关接收输入。或者，如果您的客户端服务只是想发送消息，您的输入可以来自 SNS 主题。

这些“粘合”服务通常可以从一开始就适合无服务器，但前提是它们不保持状态。在一个没有服务器的世界里，状态可能很棘手。这是因为计算能力是短暂的，甚至比虚拟机更短暂，所以你必须记住这一点。这不是一个不可能解决的问题，但它可以暂时将一些东西从“可移动”转移到“推迟”。

##### [](#email-services)邮件服务

许多应用程序都有向用户发送电子邮件的代码或服务。取决于它在您的代码库中有多复杂，它可能是一个很好的选择，可以退出并使之成为无服务器的。像 CRON 作业一样，这些服务可能在后台运行，因此不是面向用户的。如果我们没有发送一封不好的电子邮件，他们会影响用户，但是用户体验不应该与电子邮件的实际发送直接联系在一起。

在所有不同类型的用例中，发送电子邮件有非常不同的实现。一般来说，他们倾向于遵循这样的流程:

*   用户完成了某个操作，或者他们希望收到发生了某件事情的通知。
*   通常有一个电子邮件模板，用于用户需要了解的已经发生的事件。
*   电子邮件是通过模板和事件详细信息生成的。
*   然后，电子邮件被发送给用户。

根据您的用例，这里可能有更多或更少的步骤，但这是一个一般的逻辑流程。

这个流程适合无服务器。如果你幸运的话，你的电子邮件可能已经从你的独石中分离出来了。在这种情况下，您可以将逻辑移至无服务器模式，改变服务向其传递消息的方式，这样您可能就接近了。如果您的电子邮件传递被缝合到您的应用程序中，首先需要解耦，然后您可以考虑让它无服务器。

这些是一些适合无服务器架构的高级想法。这不是一个详尽的列表，因为这取决于您自己的工作量和要求。但是，我们可以把**可动**的东西概括为大体满足这三个要求。

1.  通常，不面向客户。虽然没有硬性规定，但您迁移到无服务器的第一件事通常不是面向客户的。这背后的原因各不相同，但对我来说，它归结为学习这种新的范式，同时不中断用户工作流。
2.  没有耦合到一些同步 API。当你第一次迁移到无服务器时，越多的东西是解耦的和异步的越好。为什么？因为这是建筑繁荣的地方。通过保持异步和分布式，我们允许我们的工作负载独立扩展。
3.  以具有明确界限的工作负载或服务为目标。我意识到对于大型应用程序来说，这可能是一个真正的挑战。然而，你越能为给定的服务定义一个边界，就越容易转移到无服务器。道理很简单，清晰的边界定义了清晰的契约。如果我们移动一个给定的服务，而合同不清楚或变得模糊，我们可能会以分布式技术债务而不是整体式的结束。

现在我们有了定义移动服务的原则。让我们开始思考如何实际移动它们以及我们可用的工具。

### [](#step-3-moving-the-movable)第三步:移动可移动的

既然我们已经将服务分成了两类，可移动的和不可移动的(至少现在是这样)。我们可以开始思考这个动作实际上是如何发生的。

这是一个可变的步骤，取决于你自己的代码库。您可能会决定重写一些内容，以充分利用无服务器模式。其他东西你也许可以“移植”到一个没有服务器的世界，因为它非常适合它。或者甚至有些东西你开始移动，然后意识到这是不可移动的。

这三种情况都是正确的。但是更关注前两个是有价值的，因为那是“前进”的阶段。

记住这一点，让我们考虑一下重写可能会在什么时候发生。

对于这些高级场景中的任何一个，将现有服务重写为无服务器服务都是必要的。

*   该语言/框架无法在无服务器环境下工作。也许该服务是用 Cobol 编写的，使用 Spring Boot，或者大量使用本机二进制文件。这曾经是一个更常见的问题，但是随着引入了 [AWS Lambda 层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)，这实际上不再是一个问题。
*   该服务被紧密地耦合到 monolith 中。这是一个非常常见的场景，我倾向于在旧的代码库中看到。我们希望推出这项服务，但我们可能需要扼杀旧的服务，建立一个新的服务。检查一下[扼杀者模式](https://blog.kylegalbraith.com/2019/01/29/how-to-breakthrough-the-old-monolith-using-the-strangler-pattern/)，即使无服务器不是你的未来。
*   现有代码的性能不足以在无服务器环境中运行。另一个常见的场景。也许执行时间不适合这个工作负载，或者内存太有限。

当谈到“重写为无服务器”的情况时，这是我最常看到的三种情况。我们可能会想出更多，所以在决定进行重写时，请使用您的最佳判断。

第二种方法更可取，因为它避免了重新创建现有服务的额外开销。

像前面的路径一样，我们可以设想一些高级场景，其中这条路径是可能的。

*   无服务器支持该语言/框架。说起来似乎很简单，但这实际上是一个巨大的胜利。如果您的服务已经使用了无服务器提供者现成支持的语言或框架。在这种情况下，我们可以将其移植到无服务器环境中运行。这通常意味着添加必要的代码以在函数处理程序中运行，调整监控，更新日志记录，以及进行任何额外的配置更改。
*   该服务可以在 Docker 容器中运行，或者已经被容器化。还记得在前面的路径中，我们说过在无服务器环境中不受开箱即用支持的语言或框架需要重写。如果你使用 AWS，那可能不是你唯一的选择。 [img2lambda](https://github.com/awslabs/aws-lambda-container-image-converter) 降低了这一障碍，使您可以通过使用 lambda 层直接带来这些工作负载。

这是我们在开始向无服务器模式转移可移动工作负载时可以采取的两条途径。这里还有其他方法，集装箱化是一种常见的方法。在考虑过渡到无服务器时，将工作负载转移到容器中是一个不错的折中方案。但是，更仔细的分析可能会发现这是一个不必要的步骤，您应该考虑前面两条路径中的一条。

### [](#step-4-moving-the-unmovable)第四步:移动不可移动的

但是那些我们认为不可移动的东西呢？

在这种情况下要回答的第一个问题是，当你第一次决定它是不可移动的时候，为什么它是不可移动的？当我们刚接触无服务器时，我们认为某些东西是不可移动的，因为无服务器有很多限制。

*   有限的执行时间，1-15 分钟，取决于您的云提供商。
*   与无服务器工作负载相关的冷启动延迟。
*   磁盘大小的限制，我们只有少量的暂存空间。
*   内存受限，最高 3GB，具体取决于您的云提供商。

遇到这些限制的东西也能被移动吗？当然，它们可以，但是你可能需要做一些重构。让我们来看看这些，并勾画出一些高层次的想法，你可以尝试消除限制，把它变成一个“可移动”的服务。

##### [](#limited-execution-time)限定执行时间

当无服务器架构首次引入时，这是一个有争议的限制。我们倾向于认为程序和应用程序是无限运行的。但是对于现代云计算来说，这是不必要的。

如果我们考虑云中的自动扩展组，它会横向扩展和纵向扩展，同时启动和终止工作负载。无服务器在这方面并没有太大的不同。除了在我们的“实例”从我们下面消失之前，我们有更短的时间来完成我们的工作。

如果你被困在这个限制中，你可能需要重新想象这个特殊的服务是如何工作的。

这项服务是批量服务吗？如果是这样，创建一个函数，将这项工作和另一个无服务器的工作负载分开处理。通过分散工作，我们可以利用并行化来降低执行时间。

服务可以从同步转移到异步吗？很多时候，我们从前者开始，因为它更简单。但是，异步允许我们在后台处理工作，并且在执行时间上更具战略性。

还有许多其他场景会出现这种限制。我最好的建议是创造性地思考如何在一个无服务器的世界中重构事物。你可能仍然决定不走那条路，这很正常。但是这个练习至少应该让你更多地思考为什么这是不可能的。

##### [](#cold-start-latency)冷启动潜伏期

对于许多希望迁移到无服务器架构的人来说，这仍然是一个障碍。你的函数被调用和它实际开始工作之间的时间就是我们所说的*冷启动*。

只有当您的无服务器工作负载没有以前的容器/映像/环境时，才会发生这种情况。在这种情况下，必须启动一个新的程序，必须初始化代码，然后它才能开始工作。

当您在 VPC 中运行工作负载时，这个问题在 AWS Lambda 中非常明显。您经常这样做，以便可以连接到 RDS 之类的数据库服务。由于这个问题，Lambda 实际上会在更长的时间内保持这些环境的热度。也就是说，您的同步 API 可能仍然会注意到最初的冷启动。

那么这里有哪些解决方案呢？

记录良好的“最佳实践”是 ping 您的工作负载以保持容器温暖。这是一个黑客和气味很奇怪，但它是我们目前得到的最好的。 [Serverless 实际上有一个插件就是做这个的](https://github.com/FidelLimited/serverless-plugin-warmup)。对于 AWS，您创建了一个 CRON 作业，它每 5 分钟调用一次 Lambda 函数。这为该功能保持了一个温暖的环境，因此您可以最大限度地减少冷启动。

但是，冷启动延迟不仅是云提供商的问题，也是开发人员的问题。在函数处理程序中声明的东西越多，运行的时间就越长。

全局的或者可以跨函数调用重用的东西，*应该在函数处理程序之外声明*。这是再次利用冷 vs 热启动。保持在你的处理程序之外的东西将*而不是*需要从温暖的环境中重新初始化。

冷启动是每个转向无服务器的人都应该考虑的一个限制。他们是拦路虎吗？在大多数情况下不会，因为在相当活跃的应用中，环境可能会保持温暖。但是如果你的工作量非常大，那么你会看到频繁的冷启动，因此你需要考虑上面的策略。

##### [](#disk-size-and-memory-constraints)磁盘大小和内存限制

老实说，我在运行无服务器工作负载时从未遇到过这些限制。

也就是说，如果遇到磁盘或内存限制，您可以考虑改变一些高级的东西。

在出现磁盘约束的情况下，您可能会在函数中管理某种状态，或者对非常大的文件或集合文件进行操作。在前一种情况下，把你的状态保持在外部，让它流入，而不是一次读完。这对内存和磁盘空间都有好处。

用于处理大文件。如果这是一个选项，您可能想要考虑流式传输文件并在其上展开工作。如果你可以对它进行流处理，那么你就可以告诉一个函数处理第一个块，下一个函数处理下一个块，以此类推。

在无服务器环境中，这些都是很难解决的约束，但也不是不可能。但是，他们应该会引发一场关于这种工作负载目前是否适合无服务器的讨论。

### 第五步:为成功做好准备

一旦你有了从第三步开始就已经确定可行的路径，你可能会开始考虑实施。在你走得太远之前，这里有一些技巧、过程和工具可以帮助你成功。

*   把基础设施当做代码，未来的自己会感谢你的。想想吧。您将从管理一个大型应用程序转变为管理许多无服务器工作负载。你正在从集中走向分散。灾难的一个原因是手动提供这些分布式服务。使用诸如 Terraform、无服务器框架、CloudFormation 或 Pulumi 之类的工具来简化这种管理。
*   十二因素应用程序会让你的生活更轻松。AWS 无服务器倡导者 Chris Munns 发表了一篇精彩的博客文章，主要关注无服务器环境中的方法论。
*   将服务彼此分离可以定义清晰的契约，并支持单独的扩展。再说一次，这根本不是一个新概念，而是一个提升你的无服务器游戏的概念。越多的服务可以是异步的和彼此分离的越好。让服务互相传递消息，而不是互相调用。从事件队列开始工作，而不是响应单个请求。
*   跑之前先走。当您开始转向无服务器时，从较小的服务开始。这将帮助你为自己建立良好的模式和实践。它还会揭示您可能会遇到的一些棘手问题。

### [](#conclusion)结论

无服务器工作负载是云计算的一个未来，但它们不是未来。随着技术的进步，我们将需要各种各样的计算平台。有些东西可能不适合无服务器模式，至少一开始就不适合。

没关系。但这并不是你不利用它的理由。

无服务器架构将我们从配置和管理运行系统的底层计算能力的责任中解放出来。通过摆脱这些复杂性，我们可以专注于编写向用户交付价值的代码。这是无服务器架构的附加价值。

它并不完美。它有缺点和奇怪的地方，会阻碍你的旅程，但大多数都可以通过后退一步，换个角度思考来解决。有些问题无法解决，也没关系。没有人说你的 monolith 应用程序会在一夜之间变得没有服务器。但是他们可以通过深思熟虑的计划逐步转移到那里。

### 您是否渴望了解更多关于亚马逊网络服务的信息？

如果你想开始你的 AWS 之旅，但却不知道从哪里开始，可以考虑查看我的课程。我们专注于在 AWS 上托管、保护和部署静态网站。让我们在使用时能够了解超过 6 种不同的 AWS 服务。在你掌握了基础知识之后，我们可以进入**的两个额外章节**来讨论更高级的主题，比如基础设施代码和持续部署。